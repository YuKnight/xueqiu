define(function(require,exports,module){function e(e){return xqBridge.hideLoading(),e&&6e4==e.result_code?!0:void(!e||70005!=e.result_code&&70006!=e.result_code?xqBridge.alert(e&&(e.error_description||e.msg)?{message:e.msg||e.error_description,success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}:{message:"网络错误",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}):xqBridge.redirect({type:"POP_CANCEL"}))}var t=require("template/order/trade-broker-list.js"),r=require("template/order/order-stock-list.js"),i=Util.parseParams(),n=!1;module.exports={init:function(){var e=this;e.isIB="IB"===i.tid,Util.checkBindBroker({isIB:e.isIB,success:function(r){if(r){var i=r.result_data,n=Util.getBroker(i,Util.parseParams().tid);e.broker=n,e.aid=n.aid,e.tid=n.tid,e.renew_url=n.renew_url;var s=t({data:{brokers:[n]}});$(".broker-list").append(s),e.getStockList($(".order-position")),e.bindEvent(),$(".trade").show()}else xqBridge.alert({title:"请先添加证券账户",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}})},error:function(){xqBridge.redirect({type:"POP_CANCEL"})}})},checkBind:function(r){var i=this;Util.checkAndInit({success:function(n){if(e(n)){var s=n.result_data,o=Util.getBroker(s,Util.parseParams().tid);o&&(i.broker=o,i.aid=o.aid,i.renew_url=o.renew_url,i.trader_name=o.trader_name,Util.getAndRefreshToken({aid:o.aid,renew_url:o.renew_url,success:function(){var e=t({data:{brokers:brokerList}});$(".broker-list").html(e),r&&r()},error:function(){xqBridge.redirect({type:"POP_CANCEL"})}}))}},cancel:function(){}})},getStockList:function(e){var t=this;xqBridge.request({url:"/tc/snowx/position/list.json",type:"GET",data:{aid:t.aid,tid:t.tid},success:function(i){var n=i.result_data;("PAMID"===t.tid||"PINGAN"===t.tid)&&(n=i.result_data.stocks);var s=0;n=_.filter(n,function(e){return e.enable_amount>0});var o;_.each(n,function(e){var t=e.last_price+"",r=t.split(".");if(r.length>1){var i=r[1].length;2>i&&(i=2),t-=.003*t,o=t.toFixed(i)}else t-=1,o=t.toFixed(2);e.last_price=o,s+=t*e.enable_amount}),$(".number").html(n.length);var a=r({data:{cost:s,list:n}});e.html(a).show()},error:function(e){console.log(e)},complete:function(){xqBridge.hideLoading()}})},bindEvent:function(){function e(){for(var e=$("1"==s.plan?".order-plan-all":".order-plan-latest"),t=e.find(".stock-volume .volume"),r=e.find(".stock-multi-volume input"),i=0;i<t.length;i++)$(t[i]).val(parseInt($(t[i]).val()*r[0].times))}function t(){var e=[],t=!0,r=$(".order-position");return $(".stock-list li",r).each(function(){var r=$(this),i=r.find(".stock-select");if(i.hasClass("checked")){var n=r.data("symbol"),o=r.find(".stock-name").text(),a=$.trim(r.find(".current").val()),d=$.trim(r.find(".volume").val()),l=/^-?\d+\.?\d*$/;if(!l.test(a))return Util.showError("价格必须是数字"),t=!1,!1;if(!l.test(d))return Util.showError("数量必须是数字"),t=!1,!1;d>0&&e.push({aid:s.aid,action:"SELL",scode:n,sname:o,price:a,amount:d})}}),t&&e}function r(e){var t="";return e.length&&(t+="市价卖出：\n",_.each(e,function(e){t+=e.sname+" "+e.amount+"股 \n"})),t}function i(){var e=t(),r=0;_.each(e,function(e){r+=parseFloat(e.price)*parseFloat(e.amount)});var i=$(".order-position");i.find(".amount").html(r.toFixed(2)),$(".number").text(e.length)}var s=this;$("body").on("click",".order-plan button",function(){var e=$(this);if(e.hasClass("select"))return!1;var t=$(".order-plan-latest"),r=$(".order-plan-all"),i=e.data("plan");if(s.plan=i,e.addClass("select"),e.siblings().removeClass("select"),e.hasClass("all"))r.show(),t.hide();else{var n=t.html();n.length?(t.show(),r.hide()):s.getStockList(t)}}),$("body").on("click",".select-container",function(){var e=$(this).find(".stock-select");e.hasClass("checked")?e.removeClass("checked"):e.addClass("checked"),i()}),$("body").on("click",".stock-multi-volume .button",function(){var t=$("1"==s.plan?".order-plan-all":".order-plan-latest"),r=t.find(".stock-multi-volume input");$(this).hasClass("disabled")||(r[0].previous=r.val(),r.val($(this).hasClass("plus")?parseInt(r.val())+1:parseInt(r.val())-1),r[0].now=parseInt(r.val()),r[0].times=r[0].now/r[0].previous,1==r.val()?t.find(".stock-multi-volume .minus").addClass("disabled"):t.find(".stock-multi-volume .minus").removeClass("disabled"),e(),i())}),$("body").on("blur",".stock-multi-volume input",function(){var t=$("1"==s.plan?".order-plan-all":".order-plan-latest"),r=/^[0-9]*[1-9][0-9]*$/,n=$(this);r.test($(this).val())?$(this).val()!=n[0].now&&(n[0].previous=n[0].now||1,n[0].now=n.val(),n[0].times=n[0].now/n[0].previous,e(),i(),1==$(this).val()?t.find(".stock-multi-volume .minus").addClass("disabled"):t.find(".stock-multi-volume .minus").removeClass("disabled")):(Util.showError("必须是正整数"),$(this).val(n[0].now||1))}),$("body").on("blur","input",function(){i()}),$(window).unload(function(){n||xqBridge.trackEvent("cube_order_plan_cancel")}),$("body").on("click",".order-term a",function(){var e=$(this).attr("href");return xqBridge.redirect({url:e,type:"MODAL"}),!1}),$("body").on("click",".broker-none",function(){s.checkBind()}),$("body").on("click",".submit",function(){xqBridge.trackEvent("sellAll");var e=$(this);if(e.data("disabled"))return!1;var i=t(),n=i.length;i&&n?(e.data("disabled",!1),Util.getAndRefreshToken({aid:s.aid,renew_url:s.renew_url,broker:s.broker,success:function(e){xqBridge.confirm({title:"清仓确认",message:r(i),alignment:"left",success:function(){function t(){if(r.length===n){xqBridge.hideLoading();var e=[];_.each(r,function(t){"60000"!==t.result_code&&e.push(t)}),window.location.href=e.length?"./order-fail.html?orders="+encodeURIComponent(JSON.stringify(r))+"&tid="+s.broker.tid:"./order-success.html?count="+r.length+"&tid="+s.broker.tid}}var r=[];xqBridge.showLoading();var o=i.shift();o.write_access_token=e,o.tid=s.tid,xqBridge.request({url:"/tc/snowx/order/place.json",type:"POST",data:o,success:function(e){e=_.extend(e,o),r.push(e),t(),xqBridge.getWriteToken({aid:s.aid,success:function(e){var n={writeToken:e,data:[],aid:s.aid,tid:s.tid};_.each(i,function(e,t){n.data[t]=e,n.data[t].otype="MKT",n.data[t].scode=e.scode+""}),n.data=JSON.stringify(n.data),xqBridge.request({url:"/tc/snowx/order/placebatch.json",type:"POST",data:n,success:function(e){r=r.concat(e.result_data),t()},error:function(e){Util.toast.show(e.msg),xqBridge.hideLoading()}})}})},error:function(){xqBridge.hideLoading()}})},cancel:function(){}})},error:function(){}})):_.isArray(i)&&Util.showError("请选择股票")})}}});