define(function(require,exports,module){function e(e){return xqBridge.hideLoading(),e&&6e4==e.result_code?!0:void(!e||70005!=e.result_code&&70006!=e.result_code?xqBridge.alert(e&&(e.error_description||e.msg)?{message:e.msg||e.error_description,success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}:{message:"网络错误",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}):xqBridge.redirect({type:"POP_CANCEL"}))}function t(e){var t="",i="",r="",a="";return _.indexOf(["NO_REPORT","REPORTED","PART_CONCLUDED","WAIT_WITHDRAW"],e)>-1?(t="撤单",i="blue",r="cancel"):_.indexOf(["WAIT_REPORT","WAIT_REPORT","PART_WAIT_WITHDRAW"],e)>-1?(t="撤单",i="gray",r="cancel"):_.indexOf(["PART WITHDRAW","WITHDRAWED","CONCLUDED","INVALID","PURCHASED"],e)>-1&&(t="撤单",i="gray",r="cancel",a="gray"),{opName:t,color:i,op:r,statusColor:a}}function i(e){var t="",i="",r="";return _.indexOf(["REQUESTED","REVIEWPENDING","SUBMITTED","PARTIALFILLED"],e)>-1?(t="撤单",i="blue",r="cancel"):(t="撤单",i="gray",r="cancel"),{opName:t,color:i,op:r}}function r(e){var t=!1;return _.indexOf(["PendingSubmit","PreSubmitted","Submitted"],e)>-1&&(t=!0),{canEdit:t}}function a(e,a,l){if(e.actionName=n[e.action],e.opropName=s[e.oprop],e.statusName=o[e.ostatus],e.price=parseFloat(e.price).toFixed(3),e.cprice=e.cprice?parseFloat(e.cprice).toFixed(3):"0.000",e.camount||(e.camount=0),a&&(e.statusName=d[e.ostatus]),l&&(e.statusName=c[e.ostatus]),e.oprop&&e.oprop.indexOf("MKT")>-1&&(e.price="市价"),e.otime&&!_.isNull(e.otime)){var u=e.otime+"";5===u.length&&(u="0"+u),e.time=u.slice(0,2)+":"+u.slice(2,4)+":"+u.slice(4,6)}else e.time="";var m;m=a?r(e.ostatus):l?i(e.ostatus):t(e.ostatus),_.extend(e,m)}xqBridge.trackEvent("orders");var n={BUY:"买入",SELL:"卖出",SELL_SHORT:"卖空",BUY_COVER:"补回"},s={BS:"买卖",AS:"配股",TRANS:"转托",ORDER:"申购",BORDER:"回购",RATION:"配售",SPECIFY:"指定",TTRANS:"转股",BSELL:"回售",INTEREST:"股息"},o={NO_REPORT:"未报",WAIT_REPORT:"待报",REPORTED:"已报",WAIT_WITHDRAW:"已报待撤",PART_WAIT_WITHDRAW:"部成待撤",PART_WITHDRAW:"部撤",WITHDRAWED:"已撤",PART_CONCLUDED:"部成",CONCLUDED:"已成",INVALID:"废单",PURCHASED:"已申购"},d={PendingSubmit:"未报",PendingCancel:"待撤",PreSubmitted:"待报",Submitted:"已报",ApiCanceled:"正撤",Cancelled:"已撤",Filled:"已成",Inactive:"废单"},c={REQUESTED:"已报",REVIEWPENDING:"待报",SUBMITTED:"已报",PARTIALFILLED:"部成",CANCELLING:"已报待撤",REJECTED:"废单",UPDATED:"已改",CANCELLED:"已撤",FULLFILLED:"已成",CLOSED:"已关闭",UPDATEPENDING:"已报待撤",EXPIRED:"已过期"},l=require("template/trade/orders.js");module.exports={init:function(){var t=this;t.tid=Util.parseParams().tid,t.isIB="IB"===t.tid,t.isDYZQ="DYZQ"===t.tid,t.isUSHK=t.isIB||t.isDYZQ,t.isUSHK&&$(".trade-list").find("th").eq(1).text("股票/代码"),Util.checkAndInit({isIB:t.isUSHK,success:function(i){if(e(i)){var r=i.result_data,a=Util.getBroker(r,t.tid);a&&(t.broker=a,t.aid=a.aid,t.renew_url=a.renew_url,t.getOrders(),t.isBindEvent||t.bindEvent())}},cancel:function(){xqBridge.redirect({type:"POP_CANCEL"})}})},getOrders:function(){var t=this;xqBridge.request({url:"/tc/snowx/order/list.json",data:{aid:t.aid,tid:t.tid,sort:1,row:100},type:"GET",success:function(i){e(i);var r=i.result_data;if(r.length){_.each(r,function(e){a(e,t.isIB,t.isDYZQ)});var n=l({data:{tradeList:r,isIB:t.isIB}});$(".trade-list tbody").html(n),$(".trade-list").show()}else{var s='<tr><td class="noData" colspan="5"><img src="./images/no-history.png"/><p class="title">暂无委托单</p></td></tr>';$(".trade-list tbody").html(s),$(".trade-list").show()}$(".clone").empty().append($(".trade-list").clone()).show()},error:function(e){Util.toast.show(e.msg||e.error_description||e)},complete:function(){xqBridge.hideLoading(),t.myScroll&&($(".pullDownTime span").html(moment(new Date).format("YYYY-MM-DD HH:mm:ss")),t.myScroll.refresh())}})},bindEvent:function(){function e(e){s||e.preventDefault()}this.isBindEvent=!0;var t=this,i=0;if($("body").on("click",function(e){var t=$(e.target);return t.hasClass("more")||t.parents(".ib-operate").length?void 0:($(".ib-operate").hide(),!1)}),$("body").on("click",".more",function(){var e=(new Date).getTime(),t=e-i;if(i=e,t>400){var r=$(this).parent().find(".ib-operate");r.is(":visible")?r.hide():($(".ib-operate").hide(),r.show())}return!1}),$("body").on("click",".more-disabled",function(){return xqBridge.alert({title:"",message:"由于券商限制，请使用盈透交易终端修改此订单",success:function(){}}),!1}),$("body").on("click",".edit-order",function(){var e=$(this).parents("tr"),r=e.data("action"),a=e.data("scode"),n=e.data("price"),s=e.data("amount"),o=e.data("oid"),d=e.data("etype")||"",c=a,l=t.tid;d&&/^SH|Z/.test(d)&&(c=d.slice(0,2)+a);var u={scode:c,price:n,amount:s,oid:o,tid:l,action:r},m=(new Date).getTime(),p=m-i;i=m,p>400&&xqBridge.redirect({url:"http://xueqiu.com/broker/trade?"+$.param(u),type:"PUSH"})}),$("body").on("click",".reorder",function(){var e=$(this).parents("tr"),r=e.data("scode"),a=e.data("etype")||"",n=r,s=t.tid;a&&/^SH|Z/.test(a)&&(n=a.slice(0,2)+r);var o={scode:n,tid:s},d=(new Date).getTime(),c=d-i;i=d,c>400&&xqBridge.redirect({url:"http://xueqiu.com/broker/trade?"+$.param(o),type:"PUSH"})}),window.iScroll&&!this.myScroll){var r=$("#pullDown"),a=$(".pullDownText"),n=r.outerHeight(),s=navigator.userAgent.indexOf("iPhone")>-1;$(".pullDownTime span").html(moment(new Date).format("YYYY-MM-DD HH:mm:ss")),this.myScroll=new window.iScroll("wrapper",{useTransition:!s,onBeforeScrollStart:e,topOffset:n,preventDefault:!s,onRefresh:function(){r.hasClass("loading")&&(r.removeClass("loading"),a.html("下拉刷新"))},onScrollMove:function(){this.y>5&&!r.hasClass("flip")?(r.addClass("flip"),a.html("释放刷新"),this.minScrollY=0):this.y<5&&r.hasClass("flip")&&(r.removeClass("flip"),a.html("下拉刷新"),this.minScrollY=-n)},onScrollEnd:function(){r.hasClass("flip")&&this.y>=0&&(r.addClass("loading"),a.html("数据载入中..."),t.init())}})}$(".trade-list").on("click",".btn, .cancel-order",function(){var e=(new Date).getTime(),r=e-i;if(i=e,400>r)return!1;var a=$(this).parent(),n=$(this),s=n.parents("tr");if(a.hasClass("gray"))return!1;if(n.data("disabled"))return!1;if(n.hasClass("trade"))xqBridge.redirect({url:"/broker/trade?scode="+s.data("scode"),type:"PUSH"});else{n.data("disabled",!0);var o="撤销委托单",d=$.trim(s.data("sname")),c=$.trim(s.data("scode")),l=$.trim(s.data("price")),u=$.trim(s.data("amount")),m=$.trim(s.data("etype")),p=s.data("oid"),f="股票："+d+" "+c+"\n价格："+l+"\n数量："+u;xqBridge.confirm({title:o,message:f,alignment:"left",success:function(){function e(e){xqBridge.request({url:"/tc/snowx/order/cancel.json",type:"POST",data:{oid:p+"",aid:t.aid,tid:t.tid,etype:m,write_access_token:e},success:function(e){6e4==e.result_code?xqBridge.showLoading():Util.showError(e.msg),t.getOrders()},error:function(e){Util.showError(e&&e.error_description?e.error_description:"撤单出错"),t.getOrders()},complete:function(){n.data("disabled",!1)}})}xqBridge.SNBTrackEvent({page:1506,event:1,info:{tid:t.tid||""}}),Util.getAndRefreshToken({aid:t.aid,renew_url:t.renew_url,broker:t.broker,success:function(t){e(t)},cancel:function(){}})},cancel:function(){n.data("disabled",!1)}})}})}}});