define(function(require,exports,module){var e=require("template/trade/bind-list.js"),t=Util.parseParams();module.exports={init:function(){this.getCurrentMarket(),this.getData(),this.bindEvent()},getCurrentMarket:function(){$(".market-list").find(".select").text();$(".market").text("")},getBrokersByMarket:function(e){var t="IB",r=[];return r="CN"===e?_.filter(this.brokers,function(e){return e.tid!=t}):_.filter(this.brokers,function(e){return e.tid==t})},getData:function(){var e=this;this.market=t.market||"CN",Util.appVersion()<=6.5?this.market="CN":$(".markets").show(),"CN"!=this.market&&($(".market-list li").removeClass("select"),$(".market-list li:last").addClass("select")),xqBridge.request({url:"/tc/snowx/securities.json",type:"GET",data:{},success:function(t){if(6e4==t.result_code){var r=t.result_data;e.brokers=r,e.renderBrokers=e.getBrokersByMarket(e.market),e.brokers=e.brokers.map(function(e){return"IB"===e.tid?e.trader_name="盈透证券(美/港股)":"DYZQ"===e.tid&&(e.trader_name="第一证券(美股)"),e}),e.renderHtml(e.brokers),setTimeout(function(){seajs.use("ad-banner.js",function(e){e.init("SecuritiesList_ad","SecuritiesList_closeAd")})},200)}},error:function(){xqBridge.error("获取数据出错")},complete:function(){xqBridge.hideLoading()}})},renderHtml:function(t){$(".open-broker, .open-ib").hide(),$(".no-brokers").hide(),t.length?($(".brokers").html(e({data:{brokers:t}})),"CN"==this.market?$(".open-broker").show():$(".open-ib").show()):($(".no-brokers").show(),$(".open-broker").hide())},bindEvent:function(){var e=this;Util.setPress(".broker-list li .top","onpress"),Util.setPress(".broker-list li .bottom","onpress"),$(".market-list").on("click","li",function(){var t=$(this),r=t.data("market");return t.hasClass("select")?!1:($(".broker-list").html(""),t.siblings().removeClass("select"),t.addClass("select"),e.market=r,e.renderBrokers=e.getBrokersByMarket(e.market),e.renderHtml(e.renderBrokers),void 0)}),t.ib&&$(".market-list .last").trigger("click"),$(".brokers").on("click",".broker-list li .top",function(){var t=$(this).data("tid"),r=$(this).data("bindurl"),i=_.find(e.brokers,function(e){return e.tid==t});xqBridge.trackEvent("SecuritiesList_bind"+t),xqBridge.request({url:"/account/bind/show.json",data:{},type:"GET",success:function(e){var t=function(){Util.appVersion()>=6.5&&i&&2==i.page_type&&"IB"!=i.tid?xqBridge.bindBroker({broker:i,success:function(){},error:function(){},cancel:function(){}}):("IB"==i.tid&&(r="http://xueqiu.com/broker/ib/bind?step=1"),window.location.href=encodeURI(r))};e.telephone?t():(xqBridge.trackEvent("bindPhone_bindSecurities"),xqBridge.verifyTelephone({type:"bind",success:function(){t()}}))}})}),$(".agreement").on("click",function(){return xqBridge.redirect({url:"http://xueqiu.com/law/broker-trade",type:"MODAL"}),!1}),$(".open").on("click",function(){return xqBridge.redirect({url:"http://xueqiu.com/broker/open/pingan",type:"PUSH"}),!1})}}});