!function(){"use strict";$(document).ready(function(){function t(t){return-1!==t.search("COMMISSION")}function e(t){return-1!==t.search("LOSS_DEDUCTION")}function o(t){return"USD"===t}FastClick.attach(document.body),xqBridge.trackEvent("quan_PV"),xqBridge.showLoading();var n=Util.parseParams();xqBridge.setRightNavigationButton({title:"使用规则",action:function(){xqBridge.redirect({url:"http://xueqiu.com/broker/coupon/coupon-rules",type:"PUSH",success:function(){},cancel:function(){}})}});var i={init:function(){this.couponList=[],this.activeList=[],this.usedList=[],this.lockedList=[],this.expiredList=[],this.getCouponList(),this.bindEvent()},getCouponList:function(){var o=this;xqBridge.request({url:"/tc/snowx/reward/owner/query.json",success:function(i){if(i.result_data&&0!==i.result_data.length?$(".coupon-count").show():($(".coupon-info").hide(),$(".coupon-none").show(),$(".more").hide()),"60000"===i.result_code){if(o.couponList=i.result_data,n.tid){var s=["PINGAN","PAMID"];o.couponList=i.result_data.filter(function(t){return-1!==s.indexOf(n.tid)?-1!==s.indexOf(t.tid):t.tid===n.tid})}"purchase"===n.type&&(o.couponList=o.couponList.filter(function(e){return t(e.type)})),o.couponList.map(function(t){return"ACTIVE"===t.status?o.activeList.push(t):"USED"===t.status?e(t.type)?o.lockedList.push(t):o.usedList.push(t):"PAYED"===t.status?o.usedList.push(t):"LOCKED"===t.status?o.lockedList.push(t):"EXPIRED"===t.status&&o.expiredList.push(t),t}),o.couponList=o.sortCoupon(o.activeList),0===o.couponList.length&&($(".line,.coupon-count,.coupon-info").hide(),$(".coupon-none").show(),$(".more").show()),o.renderHtml(o.couponList),n.coupon?($(".select,.coupon-select").show(),0!==$(".checked").length&&$(window).scrollTop($(".checked").offset().top-30),$(".container").css({paddingBottom:"70px"}),$(".active").on("click",function(){var t=$(this);t.find(".select").hasClass("checked")?t.find(".select").removeClass("checked"):($(".select").removeClass("checked"),t.find(".select").addClass("checked"))}),$(".coupon-select").on("click",function(){xqBridge.SNBTrackEvent({page:1510,event:2,info:{}}),xqBridge.redirect({type:"CLOSE",successData:$(".checked").data("coupon")||"none"})})):$(".active").on("click",function(){var t=$(this),o={};o.amount=t.find(".detail-amount span").text(),o.amountText=o.amount,o.name=t.find(".detail-title").text(),o.expiration=t.find(".time").text(),o.type=t.data("type"),o.currency=t.data("currency"),o.discreption=e(o.type)?"出现亏损的买卖委托单补偿返现，限平安证券可用。收盘后如该笔委托出现浮亏（买单：收盘价低于买入价／卖单：收盘价高于卖出价），将按照券面额返还至雪球钱包余额。交易券每天限用3次。":"平安证券实盘交易下单时自动提示使用，委托单成交后，券金额自动返还到雪球钱包余额。交易券每天限用3次。",o.status="有效",0!==t.find(".used").length&&(o.status="已使用"),0!==t.find(".overdue").length&&(o.status="已过期"),0!==t.find(".using").length&&(o.status="使用中"),xqBridge.SNBTrackEvent({page:1510,event:1,info:{}}),xqBridge.redirect({url:"/broker/coupon/coupon-info?"+$.param(o),type:"PUSH"})}),$(".line").show(),xqBridge.request({url:"/tc/snowx/reward/owner/remind/query.json",success:function(t){var e=0;"60000"===t.result_code&&t.result_data&&(e=t.result_data.active_count,$(".coupon-count .count").text(e+"张可用交易券"));var n=$(".coupon-count");o.fixPosition(n)},error:function(){$(".coupon-count .count").text("0张可用佣金券");var t=$(".coupon-count");o.fixPosition(t)}})}else 0===i.length&&($(".line,.coupon-count,.coupon-info").hide(),$(".coupon-none").show());xqBridge.hideLoading()},error:function(){xqBridge.hideLoading(),$(".line,.coupon-count,.coupon-info").hide(),$(".coupon-none").show()}})},sortCoupon:function(t){return t.sort(function(t,e){var o=0,n=moment(t.expiryDate).diff(moment(),"days"),i=moment(e.expiryDate).diff(moment(),"days");return o=n>i?-1:1})},fixPosition:function(t){if(!(t&&t.length&&("function"==typeof jQuery||"object"==typeof jQuery)&&t instanceof jQuery))return!1;var e=t.width(),o=t.height();"auto"!==t.css("left")&&t.css({marginLeft:"-"+(e/2+20)+"px"}),"auto"!==t.css("right")&&t.css({marginRight:"-"+e/2+"px"}),"auto"!==t.css("top")&&t.css({marginTop:"-"+o/2+"px"}),"auto"!==t.css("bottom")&&t.css({marginBottom:"-"+o/2+"px"})},renderHtml:function(t){t.map(function(t){var i=[];"ACTIVE"===t.status||"LOCKED"===t.status?(i.push(e(t.type)?'<div class="coupon-list active loss-deduction" data-type="'+t.type+'" data-currency="'+t.currency+'">':o(t.currency)?'<div class="coupon-list active us-coupon" data-type="'+t.type+'" data-currency="'+t.currency+'">':'<div class="coupon-list active" data-type="'+t.type+'"   data-currency="'+t.currency+'">'),i.push('<div class="top">')):(i.push('<div class="coupon-list" style="background-image: url(http://assets.imedao.com/images/broker/coupon/coupon-bg-gray.png);">'),i.push('<div class="top gray">')),i.push(o(t.currency)?'<div class="detail-amount"><i>$</i><span>'+t.faceValue+"</span></div>":'<div class="detail-amount"><i>￥</i><span>'+t.faceValue+"</span></div>"),i.push('<div class="detail-title">'+t.name+"</div>"),i.push('<div class="detail-num">'+t.num+"张</div></div>"),i.push('<div class="bottom"><div class="tip">'+t.label+"</div>"),i.push('<div class="time">有效期'+moment(t.startDate).format("YYYY/MM/DD")+"至"+moment(t.expiryDate).format("YYYY/MM/DD")+"</div>"),("USED"===t.status||"PAYED"===t.status)&&i.push('<div class="gone used"></div>'),"LOCKED"===t.status&&i.push('<div class="gone using"></div>'),"EXPIRED"===t.status&&i.push('<div class="gone overdue"></div>'),n.coupon&&i.push(n.coupon===t.rewardOwnerId?'<div class="select checked" data-coupon="'+t.rewardOwnerId+'" data-type="'+t.type+'" data-currency="'+t.currency+'"></div>':'<div class="select" data-coupon="'+t.rewardOwnerId+'" data-type="'+t.type+'" data-currency="'+t.currency+'"></div>'),i.push("</div></div>");var s=i.join("");$(".coupon-info").append(s)}),$(".more").show()},bindEvent:function(){var t=this;$(".more").on("click",function(){xqBridge.SNBTrackEvent({page:1510,event:0,info:{}}),$(".line,.coupon-count,.coupon-info").show(),$(".coupon-none").hide(),t.renderHtml(t.sortCoupon(t.lockedList).concat(t.sortCoupon(t.usedList)).concat(t.sortCoupon(t.expiredList))),$(this).hide()}),$(".rule").on("click",function(){xqBridge.redirect({url:"http://xueqiu.com/broker/coupon/coupon-rules",type:"PUSH"})})}};i.init()})}();