define(function(require,exports,module){function e(e){return xqBridge.hideLoading(),e&&6e4==e.result_code?!0:void(!e||70005!=e.result_code&&70006!=e.result_code?xqBridge.alert(e&&(e.error_description||e.msg)?{message:e.msg||e.error_description,success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}:{message:"网络错误",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}):xqBridge.redirect({type:"POP_CANCEL"}))}xqBridge.trackEvent("transfer"),module.exports={init:function(){var t=this;this.bankDefer=$.Deferred(),this.assetsDefer=$.Deferred(),$.when(this.bankDefer,this.assetsDefer).then(function(){xqBridge.hideLoading(),$("#container").css({height:document.body.clientHeight}).show(),t.bindEvent()}),xqBridge.setRightNavigationButton({title:"转账记录",action:function(){xqBridge.redirect({url:"/broker/transfer-history?tid="+t.broker.tid,type:"PUSH",success:function(){},cancel:function(){}})}}),Util.checkAndInit({success:function(n){if(e(n)){var r=n.result_data,s=Util.getBroker(r,Util.parseParams().tid);s&&(t.broker=s,t.aid=s.aid,t.tid=s.tid,xqBridge.getUserInfo({success:function(e){t.uid=e.uid,t.getBank(),t.getAccountInfo()}}))}},cancel:function(){xqBridge.redirect({type:"POP_CANCEL"})}})},getBank:function(){var e=this;xqBridge.request({url:"/tc/snowx/bank/query.json",data:{aid:e.aid,tid:e.tid,uid:e.uid},type:"GET",success:function(t){var n=_.first(t.result_data);if(n){e.bank=n,$(".bank-name").text(n.bank_name).data("bno",n.bank_no);var r=$(".transfer-type .select").data("type");1==r&&("bank"===n.intoNeed?$(".bank-password").show():"fund"===n.intoNeed?$(".fund-password").show():"both"===n.intoNeed?($(".bank-password").show(),$(".fund-password").show()):n.needBankPW&&$(".bank-password").show()),2==r&&("bank"===n.outNeed?$(".bank-password").show():"fund"===n.outNeed?$(".fund-password").show():"both"===n.outNeed?($(".bank-password").show(),$(".fund-password").show()):n.needFundPW&&$(".fund-password").show()),n.is_first_in&&(Util.overlay.showOverlay($(".confirm")),$(".course-button").on("click",function(){n.first_in_tutorial_url&&xqBridge.redirect({url:n.first_in_tutorial_url,type:"PUSH",success:function(){},cancel:function(){}})}),$(".finished-button").on("click",function(){Util.overlay.hideOverlay($(".confirm"))})),n.can_query_balance&&($(".balance").show(),n.need_query_password?$(".balance").addClass("active"):e.getBankBalance())}else xqBridge.alert({message:t.msg||"尚未绑定银行卡，请联系券商",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}})},complete:function(){e.bankDefer.resolve()}})},getAccountInfo:function(){var e=this;xqBridge.request({url:"/tc/snowx/fund/query.json",type:"GET",data:{aid:e.aid,tid:e.tid},success:function(e){var t=_.first(e.result_data),n="--";t&&(n=t.fetch_balance),$(".enable-amount").text(n),$(".enable").click(function(){$(".amount").val(n)})},complete:function(){e.assetsDefer.resolve()}})},getBankBalance:function(e){var t=this;xqBridge.request({url:"/tc/snowx/bank/balance/query.json",type:"GET",data:{bank_no:t.bank.bank_no,tid:t.tid,aid:t.aid,account_password:e||""},success:function(e){e&&6e4==e.result_code?(Util.overlay.hideOverlay($(".prompt")),e.result_data.bank_balance?$(".balance").text("可转金额："+e.result_data.bank_balance+"元").removeClass("active"):$(".balance").addClass("active")):($(".balance").addClass("active"),Util.toast.show(e.msg))},complete:function(){}})},bindEvent:function(){var e=this,t=0,n=0;$("li").on("click",function(){$(this).find("input").focus()}),$(".transfer-type").on("click","div",function(){if($(this).hasClass("select"))return!1;$(this).siblings().removeClass("select"),$(this).addClass("select");var r=$(".transfer-type .select").data("type"),s=e.bank;$(".bank-password, .fund-password").hide(),1==r&&("bank"===s.intoNeed?$(".bank-password").show():"fund"===s.intoNeed?$(".fund-password").show():"both"===s.intoNeed?($(".bank-password").show(),$(".fund-password").show()):s.needBankPW&&$(".bank-password").show(),xqBridge.trackEvent("bank_bankToSec"),$(".submit button").text("转入到证券"),$("body").removeClass("out")),2==r&&("bank"===s.outNeed?$(".bank-password").show():"fund"===s.outNeed?$(".fund-password").show():"both"===s.outNeed?($(".bank-password").show(),$(".fund-password").show()):s.needFundPW&&$(".fund-password").show(),xqBridge.trackEvent("bank_secToBank"),$(".submit button").text("转出到银行"),$("body").addClass("out")),1===$(this).data("type")?(t=$(".amount").val(),$(".amount").val(n)):(n=$(".amount").val(),$(".amount").val(t))}),$(".submit").on("click",function(){var t=$(this),n=e.uid,r=e.aid,s=e.tid,a=$(".transfer-type").find(".select").data("type"),i=$(".bank-name").data("bno"),o=$.trim($(".amount").val()),d=$.trim($(".fpassword").val()),c=$.trim($(".bpassword").val()),u={uid:n,aid:r,tid:s,transfer_direction:a,cur:"CNY"};if(!i)return Util.showError("获取不到银行信息"),!1;if(""===o)return Util.showError("请输入正确的转账金额"),!1;var l=$(".bank-password").is(":visible"),f=$(".fund-password").is(":visible");if(l){var b=$.Deferred();if(!c)return Util.showError("请输入银行密码"),!1;Util.appVersion()>=7.3?xqBridge.encryptWithRSA({origin:c,success:function(e){u.bank_password_encrypted=e,b.resolve()},error:function(){u.bank_password=c,b.resolve()}}):(u.bank_password=c,b.resolve())}if(f){var p=$.Deferred();if(!d)return Util.showError("请输入资金密码"),!1;Util.appVersion()>=7.3?xqBridge.encryptWithRSA({origin:d,success:function(e){u.fund_password_encrypted=e,p.resolve()},error:function(){u.fund_password=d,p.resolve()}}):(u.fund_password=d,p.resolve())}_.extend(u,{bank_no:i,balance:o}),$.when(b,p).then(function(){return t.hasClass("disabled")?!1:(t.addClass("disabled"),void Util.getAndRefreshToken({aid:r,renew_url:e.broker.renew_url,broker:e.broker,success:function(n){function r(){xqBridge.confirm({title:"提示",message:"银转委托提交中\n\n是否成功请在银转记录页面查看。",alignment:"center",success_button:"查看银转记录",success:function(){xqBridge.redirect({url:"/broker/transfer-history?tid="+e.broker.tid,type:"PUSH"})}})}u.write_access_token=n,xqBridge.showLoading(),xqBridge.request({url:"/tc/snowx/bank/transfer.json",type:"POST",data:u,success:function(t){if(6e4==t.result_code){var n=_.first(t.result_data);n&&n.oid?Util.showError("委托成功，编号为："+n.oid,function(){xqBridge.redirect({url:"/broker/transfer-history?tid="+e.broker.tid,type:"PUSH"})}):(Util.showError(t.msg),xqBridge.redirect({url:"/broker/transfer-history?tid="+e.broker.tid,type:"PUSH"})),$("input").val(""),e.getAccountInfo()}else-1!==["70010","70000","79014","70007"].indexOf(t.result_code)?r():Util.showError(t.msg)},error:function(e){"70005"===e.result_code?Util.toast.show(e.msg):r()},complete:function(){t.removeClass("disabled"),xqBridge.hideLoading()}})},cancel:function(){xqBridge.hideLoading(),t.removeClass("disabled")},error:function(){xqBridge.hideLoading(),t.removeClass("disabled")}}))})});var r=$(".prompt");$("body").on("click",".balance.active",function(){e.bank.need_query_password?(r=$(".prompt"),r.find("title").text(e.bank.bank_name),r.find("input").attr("placeholder","请输入"+e.bank.password_type),Util.overlay.showOverlay(r)):e.getBankBalance()}),r.on("click",".success-button",function(){var t=$(".prompt").find("input").val();t?e.getBankBalance(t):Util.toast.show("请输入"+e.bank.password_type)}),r.on("click",".cancel-button",function(){Util.overlay.hideOverlay(r)}),window.viewDidAppear=function(){e.bank.can_query_balance&&(e.bank.need_query_password?$(".balance").addClass("active").text("查询可转金额"):e.getBankBalance())}}}});