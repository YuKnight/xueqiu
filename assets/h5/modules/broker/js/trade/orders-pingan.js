define(function(require,exports,module){function e(e){return xqBridge.hideLoading(),e&&6e4==e.result_code?!0:void(!e||70005!=e.result_code&&70006!=e.result_code?xqBridge.alert(e&&(e.error_description||e.msg)?{message:e.msg||e.error_description,success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}:{message:"网络错误",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}):xqBridge.redirect({type:"POP_CANCEL"}))}function t(e){var t="",i="",r="",a="";return _.indexOf(["NO_REPORT","REPORTED","PART_CONCLUDED","WAIT_WITHDRAW"],e)>-1?(t="撤单",i="blue",r="cancel"):_.indexOf(["WAIT_REPORT","WAIT_REPORT","PART_WAIT_WITHDRAW"],e)>-1?(t="撤单",i="gray",r="cancel"):_.indexOf(["PART WITHDRAW","WITHDRAWED","CONCLUDED","INVALID","PURCHASED"],e)>-1&&(t="撤单",i="gray",r="cancel",a="gray"),{opName:t,color:i,op:r,statusColor:a}}function i(e){var t=!1;return _.indexOf(["PendingSubmit","PreSubmitted","Submitted"],e)>-1&&(t=!0),{canEdit:t}}function r(e,r){if(e.actionName=a[e.action],e.opropName=s[e.oprop],e.statusName=n[e.ostatus],e.price=parseFloat(e.price).toFixed(3),e.cprice=e.cprice?parseFloat(e.cprice).toFixed(3):"0.000",e.camount||(e.camount=0),r&&(e.statusName=o[e.ostatus]),e.oprop&&e.oprop.indexOf("MKT")>-1&&(e.price="市价"),e.otime&&!_.isNull(e.otime)){var d=e.otime+"";5===d.length&&(d="0"+d),e.time=d.slice(0,2)+":"+d.slice(2,4)+":"+d.slice(4,6)}else e.time="";var c;c=r?i(e.ostatus):t(e.ostatus),_.extend(e,c)}xqBridge.trackEvent("orders");var a={BUY:"买入",SELL:"卖出",SELL_SHORT:"卖空",BUY_COVER:"补回"},s={BS:"买卖",AS:"配股",TRANS:"转托",ORDER:"申购",BORDER:"回购",RATION:"配售",SPECIFY:"指定",TTRANS:"转股",BSELL:"回售",INTEREST:"股息"},n={NO_REPORT:"未报",WAIT_REPORT:"待报",REPORTED:"已报",WAIT_WITHDRAW:"已报待撤",PART_WAIT_WITHDRAW:"部成待撤",PART_WITHDRAW:"部撤",WITHDRAWED:"已撤",PART_CONCLUDED:"部成",CONCLUDED:"已成",INVALID:"废单",PURCHASED:"已申购"},o={PendingSubmit:"未报",PendingCancel:"待撤",PreSubmitted:"待报",Submitted:"已报",ApiCanceled:"正撤",Cancelled:"已撤",Filled:"已成",Inactive:"废单"},d=require("template/trade/orders-pingan.js");module.exports={init:function(){this.tid=Util.parseParams().tid,this.isIB="IB"===this.tid;var e=userInfo.brokerList,t=Util.getBroker(e,this.tid);t&&t.tid===this.tid?(this.broker=t,this.aid=t.aid,this.renew_url=t.renew_url,this.getOrders(),this.isBindEvent||this.bindEvent()):xqBridge.alert({message:"券商未绑定",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}})},getOrders:function(t){var i=this;return"end"==t||i.isLoading?!1:(i.isLoading=!0,void xqBridge.request({url:"/tc/snowx/order/list.json",data:{aid:i.aid,tid:i.tid,sort:1,pos:t||""},type:"GET",success:function(a){e(a);var s=a.result_data;if(t||0!=s.length){_.each(s,function(e){r(e,i.isIB)});var n=d({data:{tradeList:s,pos:t||""}});t?$(".history-list .update-history").replaceWith(n):$(".history-list").html(n),$(".history-list").removeClass("fn-hide"),i.last_pos=a.last_pos}else{var o='<div class="no-history"><img src="./images/no-history.png"><p class="title">暂无委托单</p></div>';$(".history-list").html(o),$(".history-list").removeClass("fn-hide")}i.last_pos=s&&s.length<20?"end":a.last_pos},complete:function(){i.isLoading=!1,xqBridge.hideLoading(),i.myScroll&&($(".pullDownTime span").html(moment(new Date).format("YYYY-MM-DD HH:mm:ss")),i.myScroll.refresh())}}))},bindEvent:function(){this.isBindEvent=!0;var e=this,t=0;$("body").on("click",function(e){var t=$(e.target);return t.hasClass("more")||t.parents(".ib-operate").length?void 0:($(".ib-operate").hide(),!1)}),$("body").on("click",".more",function(){var e=(new Date).getTime(),i=e-t;if(t=e,i>400){var r=$(this).parent().find(".ib-operate");r.is(":visible")?r.hide():($(".ib-operate").hide(),r.show())}return!1}),$("body").on("click",".edit-order",function(){var i=$(this).parents("tr"),r=i.data("action"),a=i.data("scode"),s=i.data("price"),n=i.data("amount"),o=i.data("oid"),d=i.data("etype")||"",c=a,l=e.tid;d&&/^SH|Z/.test(d)&&(c=d.slice(0,2)+a);var u={scode:c,price:s,amount:n,oid:o,tid:l,action:r},p=(new Date).getTime(),m=p-t;t=p,m>400&&xqBridge.redirect({url:"http://xueqiu.com/broker/trade?"+$.param(u),type:"PUSH"})}),$("body").on("click",".reorder",function(){var i=$(this).parents("tr"),r=i.data("scode"),a=i.data("etype")||"",s=r,n=e.tid;a&&/^SH|Z/.test(a)&&(s=a.slice(0,2)+r);var o={scode:s,tid:n},d=(new Date).getTime(),c=d-t;t=d,c>400&&xqBridge.redirect({url:"http://xueqiu.com/broker/trade?"+$.param(o),type:"PUSH"})}),$(".history-list").on("click",".btn, .cancel-order",function(){var i=(new Date).getTime(),r=i-t;if(t=i,400>r)return!1;var a=$(this).parent(),s=$(this),n=s.parents("tr");if(a.hasClass("gray"))return!1;if(s.data("disabled"))return!1;if(s.hasClass("trade"))xqBridge.redirect({url:"/broker/trade?scode="+n.data("scode"),type:"PUSH"});else{s.data("disabled",!0);var o="撤销委托单",d=$.trim(n.data("sname")),c=$.trim(n.data("scode")),l=$.trim(n.data("price")),u=$.trim(n.data("amount")),p=$.trim(n.data("etype")),m=n.data("oid"),g="股票："+d+" "+c+"\n价格："+l+"\n数量："+u;xqBridge.confirm({title:o,message:g,alignment:"left",success:function(){function t(t){xqBridge.request({url:"/tc/snowx/order/cancel.json",type:"POST",data:{oid:m+"",aid:e.aid,tid:e.tid,etype:p,write_access_token:t},success:function(t){6e4==t.result_code?xqBridge.showLoading():Util.showError(t.msg),e.getOrders()},error:function(t){Util.showError(t&&t.error_description?t.error_description:"撤单出错"),e.getOrders()},complete:function(){s.data("disabled",!1)}})}xqBridge.SNBTrackEvent({page:1506,event:1,info:{tid:e.tid||""}}),Util.getAndRefreshToken({aid:e.aid,renew_url:e.renew_url,broker:e.broker,success:function(e){t(e)},cancel:function(){}})},cancel:function(){s.data("disabled",!1)}})}})}}});