define(function(require,exports,module){var e=require("template/trade/open-list.js"),t=Util.parseParams();t.from&&xqBridge.trackEvent("openList_"+t.from);var r=navigator.userAgent.indexOf("iPhone")>-1;module.exports={init:function(){this.renderSlide(),this.getCurrentMarket(),this.getData(),this.bindEvent(),this.addNavBtn()},renderSlide:function(){var e=this;xqBridge.request({url:"/tc/snowx/ad/list.json",data:{ad_type:1},success:function(t){var r=t.result_data,i=[];if(e.imgToUrl={},_.each(r,function(t){i.push({content:t.image_src+"?sortid="+t.sortid,sortid:t.sortid}),e.imgToUrl[t.image_src+"?sortid="+t.sortid]=t.ad_url}),i.sort(function(e,t){return e.sortid-t.sortid}),i.length){var n=$("body").width(),o=.3125*n,s=o+40-10;if($("#iSlider-wrapper").css({height:o,backgroundImage:"url('./images/common_defaultimage_logo.png')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:o/2+"px "+o/2+"px"}),i.length>1){{var a={type:"pic",data:i,dom:document.getElementById("iSlider-wrapper"),animateType:"rotate",isLooping:!0,duration:3e3,isAutoplay:!0,initIndex:0};new iSlider(a)}$(".islider-dot-wrap").css({top:s})}else $("#iSlider-wrapper").html('<img width="100%" src="'+i[0].content+'"/>')}else $("#iSlider-wrapper").hide()}})},getCurrentMarket:function(){$(".market-list").find(".select").text();$(".market").text("")},getBrokersByMarket:function(e){var t="IB",r=[];return r="CN"===e?_.filter(this.brokers,function(e){return e.tid!=t}):_.filter(this.brokers,function(e){return e.tid==t})},getData:function(){var e=this;this.market=t.market||"CN",Util.appVersion()<6.6?(this.market="CN",$("#iSlider-wrapper").css({"margin-top":"0px"})):$(".markets").show(),xqBridge.request({url:"/tc/snowx/opening/list.json",type:"GET",data:{},success:function(t){if(6e4==t.result_code){e.fixData(t.result_data);var r=t.result_data;e.brokers=r,e.renderBrokers=e.getBrokersByMarket(e.market),e.brokers=e.brokers.map(function(e){return"IB"===e.tid&&(e.trader_name="盈透证券(美/港股)"),"DYZQ"===e.tid&&(e.trader_name="第一证券(美股)"),e}),e.renderHtml(e.brokers)}},error:function(){Util.showError("获取数据失败，请检查网络")},complete:function(){xqBridge.hideLoading()}})},fixData:function(e){_.each(e,function(e){e.tags=e.tags?e.tags.split(","):[]})},renderHtml:function(t){$(".no-brokers").hide(),t.length?$(".brokers").html(e({data:{brokers:t}})):$(".no-brokers").show(),r||$(".tags span").css({padding:"1px 6px"})},bindEvent:function(){var e=this;Util.setPress(".broker-list li .top","onpress"),Util.setPress(".broker-list li .bottom","onpress"),$("#iSlider-wrapper").on("click","img",function(){var t=decodeURIComponent(this.src),r=e.imgToUrl[t];xqBridge.redirect({url:r,type:"PUSH"})}),$(".market-list").on("click","li",function(){var t=$(this),r=t.data("market");return t.hasClass("select")?!1:($(".broker-list").html(""),t.siblings().removeClass("select"),t.addClass("select"),e.market=r,e.renderBrokers=e.getBrokersByMarket(e.market),e.renderHtml(e.renderBrokers),void 0)}),t.ib&&$(".market-list .last").trigger("click"),$(".brokers").on("click",".broker-list li",function(e){var t=$(e.target),r=$(this).data("tid");t.hasClass("button")?(xqBridge.trackEvent("SecuritiesList_openButton_"+r),xqBridge.trackEvent("openButton_"+r)):xqBridge.trackEvent("SecuritiesList_open"+r);var i=function(){xqBridge.showLoading();var e=1;Util.appVersion()>6.7&&(e=2),xqBridge.request({url:"/tc/snowx/opening.json",data:{tid:r,notify_type:e},type:"POST",success:function(t){if(6e4==t.result_code){xqBridge.updateBrokerList();var r=t.result_data,i=navigator.userAgent.indexOf("iPhone")>-1,n=i?r.ios_notify_url:r.apk_notify_url,o=i?r.ios_download_url:r.apk_download_url,s="",a=n.split("-");e=r.notify_type?r.notify_type:1,2!==a.length||i||(n=a[1],s=a[0]),3===e?xqBridge.redirect({url:r.redirect_url,type:"PUSH"}):xqBridge.wakeApp({notifyUrl:n,downloadUrl:o,openType:s,notifyType:e})}else Util.showError(t.msg)},error:function(){},complete:function(){xqBridge.hideLoading()}})};xqBridge.request({url:"/account/bind/show.json",data:{},type:"GET",success:function(e){e.telephone?i():(xqBridge.trackEvent("bindPhone_bindSecurities"),xqBridge.verifyTelephone({type:"bind",success:function(){i()}}))}})}),$(".agreement").on("click",function(){return xqBridge.redirect({url:"/broker/terms",type:"MODAL"}),!1})},addNavBtn:function(){xqBridge.setRightNavigationButton({title:"开户帮助",action:function(){xqBridge.redirect({url:"http://xueqiu.com/broker/trade/qa",type:"PUSH",success:function(){},cancel:function(){}})}})}}});