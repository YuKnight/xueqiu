define(function(require,exports,module){var e,t=require("template/trade/trade-broker-list.js"),a=require("template/trade/trade-price-info.js"),r=require("template/trade/trade-wudang.js"),o=require("template/trade/trade-action.js"),i=["IB","DYZQ"],s=Util.parseParams(),n=function(e){this.rules=e};n.prototype.validateAll=function(){for(var e in c)if(c[e].rule()!==!0)return Util.toast.show(c[e].rule()),!1;return!0},n.prototype.validate=function(e){return this.rules[e]?this.rules[e].rule():!0};var c={scode:{rule:function(){var e=$("#scode").data("symbol");return e?!0:"未选择股票"}},price:{rule:function(){var e=$(".price").val()||s.price;return e?/^-?\d+\.?\d*$/.test(e)?!0:"价格必须是数字":"价格不能为空"}},amount:{rule:function(){var e=$(".amount").val();return e?/^-?\d+\.?\d*$/.test(e)?!0:"数量必须是数字":"数量不能为空"}}};module.exports={init:function(){var e=this;xqBridge.trackEvent("trade"),this.action=s.action||"BUY",this.symbol=s.scode,this.etype=Util.getEtypeBySymbol(this.symbol),this.isUSHK="USEX"===this.etype||"HKEX"===this.etype,this.tid=s.tid,this.type="LMT",this.isEdit=!1,this.isVisible=!0,this.coupon={},this.quote={},this.couponList=[],this.hasCoupon="init",this.validate=new n(c),this.tradeType="normal",-1!==_.indexOf(i,this.tid)&&(this.tradeType="USHK"),this.renderTradeBody(!0).done(function(){e.fillTradeData(),e.updateBodyClass(),e.bindEvent()})},renderTradeBody:function(e){var t=this,a=$.Deferred(),r=function(){$(".trade-body").replaceWith($(o({tradeType:t.tradeType}))),e||t.changeBroker(t.broker.tid),$(".trade").removeClass("fn-hide"),e||("SELL"===t.action?$("button.sell").trigger("click"):$("button.buy").trigger("click"))};return s.subscribeCode?(this.tradeType="newStock",r(),a.resolve()):t.symbol?xqBridge.request({url:"/v4/stock/quote.json",data:{code:t.symbol},success:function(e){var o=e[t.symbol];t.quote=o,"17"===o.type?t.tradeType="purchase":t.isUSHK?t.tradeType="USHK":("purchase"===t.tradeType&&(t.action="BUY"),t.tradeType="normal"),"0"===e.flag?xqBridge.request({url:"/preipo/subdate.json",type:"GET",data:{begin:(new Date).toISOString().substring(0,10),end:(new Date).toISOString().substring(0,10),count:50},success:function(e){e=e.filter(function(e){return e.symbol===t.symbol}),e.length>0&&(t.tradeType="newStock",s.scode=e[0].symbol,s.name=e[0].name,s.action="BUY",s.subscribeCode=e[0].onl_subcode,s.subscribeQty=1e4*e[0].onl_submaxqty,s.price=e[0].iss_price||0,s.tid="PAMID"),r(),t.afterRender(o)},error:function(e){console.log(e)},complete:function(){a.resolve()}}):(r(),t.afterRender(o),a.resolve())},error:function(e){t.action="BUY",t.tradeType="normal",r(),a.resolve(),console.log(e)}}):(r(),a.resolve()),a},afterRender:function(e){var t=this;if("purchase"===t.tradeType){t.action="SELL",$("button.sell").trigger("click");var a="("+parseInt(e.name.substring(e.name.length-3,e.name.length))+"天期)";if($("#scode").val(e.name+" "+e.code+a).data("symbol",e.code).data("name",e.name),"SH"===e.exchange?$(".plus, .minus",$(".amount-group")).data("unit",1e5).find(".step").text("10万"):"SZ"===e.exchange?$(".plus, .minus",$(".amount-group")).data("unit",1e3).find(".step").text(1e3):$(".plus, .minus",$(".amount-group")).data("unit",100).find(".step").text(100),$(".type-group").hasClass("disable")||($(".trade-type").find("li").eq(0).trigger("click"),$(".type-group").addClass("disable")),e.trading_date&&e.trading_date.length>0&&e.actual_date&&e.actual_date.length>0&&e.preferable_date&&e.preferable_date.length>0){var r=moment(parseInt(e.trading_date)),o=moment(parseInt(e.actual_date)),i=moment(parseInt(e.preferable_date));$(".purchase-out .purchase-date").text(r.format("YYYY-MM-DD")),$(".fund-back .purchase-date").text(o.format("YYYY-MM-DD")),$(".can-pick .purchase-date").text(i.format("YYYY-MM-DD")),$(".purchase-time").show()}else $(".purchase-time").hide()}else"newStock"===t.tradeType&&(t.action="BUY",$("button.buy").trigger("click"));t.updateBodyClass(),t.caculateStyle()},fillTradeData:function(){var e=this;"normal"===e.tradeType&&"SELL"===this.action&&($("#submit-order span").html("卖  出"),$(".trade-action .select").removeClass("select"),$(".trade-action button:last").addClass("select")),xqBridge.showLoading(),xqBridge.getUserInfo({success:function(t){window.userInfo=t?t:{},t&&t.stColor&&$("body").addClass("oppositeColor"),Util.checkBindBroker({success:function(t){e.brokers=t.result_data||[],e.changeBroker(e.tid),xqBridge.hideLoading(),$(".trade").removeClass("fn-hide"),e.caculateStyle(),e.updateBodyClass(),s.scode?"newStock"===e.tradeType?($("#scode").val(s.name+" "+s.scode).data("symbol",s.scode).data("name",s.name),$(".subscribeCode").text(s.subscribeCode),$(".price").text(s.price+"元"),e.getStockAmount()):(e.getPanKouInfo(s.scode,!0),s.oid&&(e.isEdit=!0,$("#scode").attr("disabled","disabled").css({"background-color":"#fff"}))):$(".wudang-prices").html(r({data:e.fixData({}),isPurchase:"purchase"===e.tradeType})).addClass("no-data"),"SELL"===e.action?$("button.sell").trigger("click"):$("button.buy").trigger("click")},error:function(){xqBridge.redirect({type:"POP_CANCEL"})}})},error:function(e){Util.errorHandler(e)}})},updateBodyClass:function(){var e=$("body");e.removeClass("BUY"),e.removeClass("SELL"),e.addClass(this.action),this.isUSHK||"USHK"===this.tradeType?($("body").addClass("USHK"),$(".mkt-price").text("市价")):($("body").removeClass("USHK"),$(".mkt-price").text("最优五档即时成交剩余撤销")),this.broker&&this.broker.tid&&_.indexOf(i,this.broker.tid)>-1?(e.addClass("special-broker"),e.addClass("special-broker-"+this.broker.tid)):_.map(i,function(t){e.removeClass("special-broker-"+t)})},caculateStyle:function(){var e=$(document).width(),t=e-110-.06*e-80-15;this.isUSHK&&(t+=110),$(".price, .amount").css({width:t});var a=$(".type-group"),r=a.offset(),o=a.outerHeight(),i=a.outerWidth();r&&$(".trade-type").css({top:r.top+o,left:0,width:i,"padding-left":.03*e})},getBrokers:function(e,t,a){function r(){"newStock"===o.tradeType&&(e=[],xqBridge.confirm(Util.appVersion()<7.2?{title:"提示",message:"请更新最新雪球客户端",alignment:"left",success_button:"更新",cancel_button:"返回",success:function(){window.location.href="http://xueqiu.com/xz"},cancel:function(){xqBridge.redirect({type:"POP"})}}:{title:"提示",message:"新股申购只支持平安证券，请添加平安证券后再试。",alignment:"left",success_button:"添加",cancel_button:"返回",success:function(){xqBridge.redirect({type:"MODAL",url:"/broker/bind-list"})},cancel:function(){xqBridge.redirect({type:"POP"})}}))}var o=this;if(e.length&&a&&(e=_.filter(e,function(e){return e.etype&&e.etype.indexOf(a)>-1})),e.length){var i=_.find(e,function(e){return e.is_default});if(i||(i=_.first(e),i.is_default=!0),t){var s=_.find(e,function(e){return e.tid==t});s?(s.is_default=!0,i&&i.tid!=t&&(i.is_default=!1)):r()}}else r();return e},checkCoupon:function(){var e=this,t=parseFloat($(".commission-amount").text());if("799999"===e.symbol)return!1;if("newStock"===e.tradeType)return $(".coupon").hide(),!1;if("init"===e.hasCoupon&&e.broker)xqBridge.request({url:"/tc/snowx/reward/best/query.json",data:{tid:e.broker.tid,commission:parseFloat(t)||0},success:function(t){"60000"===t.result_code?xqBridge.request({url:"/tc/snowx/reward/owner/query.json",success:function(t){if("60000"===t.result_code)if(null===t.result_data||0===t.result_data.length)$(".coupon").css({display:"block"}),$("#coupon-text").text("暂无券可用").css({color:"#ccc"}),e.coupon={},e.hasCoupon="keep";else{var a=["PINGAN","PAMID"];e.couponList=t.result_data.filter(function(t){return-1!==a.indexOf(e.broker.tid)?-1!==a.indexOf(t.tid):t.tid===e.broker.tid}),e.hasCoupon="yep",e.checkCoupon()}else e.hasCoupon=!1,$(".coupon").hide()},error:function(){e.hasCoupon=!1,$(".coupon").hide()}}):"74007"===t.result_code?($(".coupon").css({display:"block"}),$("#coupon-text").text("今日交易券使用已满3次").css({color:"#ccc"}),$(".coupon i").hide(),e.coupon={},$(".coupon").off("click"),e.hasCoupon="keep"):(e.hasCoupon=!1,$(".coupon").hide())},error:function(){e.hasCoupon=!1,$(".coupon").hide()}});else if("yep"===e.hasCoupon){var a=e.couponList,r={};if("purchase"===e.tradeType&&(a=a.filter(function(e){return"ACTIVE"===e.status&&"亏损抵用券"!==e.name})),a=a.filter(function(e){return"ACTIVE"===e.status&&moment().diff(moment(e.startDate),"days")>=0&&moment().diff(moment(e.expiryDate),"days")<=0}).reverse().map(function(e){if(_.isEmpty(r))r=e;else{var t=moment(e.expiryDate),a=moment(r.expiryDate);t.diff(a,"days")<0?r=e:0===t.diff(a,"days")&&(e.name===r.name?e.faceValue>r.faceValue&&(r=e):"交易体验券"===e.name&&(r=e))}return e}),0===a.length)return $(".coupon").hide(),!1;$(".coupon").css({display:"block"}),$("#coupon-text").css({color:"#FF7700"}).text("DYZQ"===e.broker.tid?r.name+"($"+r.faceValue+")":r.name+"(￥"+r.faceValue+")"),$(".coupon i").show(),e.coupon=r}else{if("keep"===e.hasCoupon)return!1;e.hasCoupon=!1,$(".coupon").hide()}},checkBind:function(t){var a=this,r=$("#submit-order");if(a.broker)"SUCCESS"==a.broker.status?(xqBridge.trackEvent("trade_confirmAlert"),xqBridge.confirm({title:t.title,message:t.message,alignment:"left",success:function(){xqBridge.SNBTrackEvent({page:1504,event:9,info:{tid:a.tid||""}}),Util.getAndRefreshToken({aid:a.broker.aid,renew_url:a.broker.renew_url,broker:a.broker,from:"trade",success:function(o){function i(){xqBridge.confirm({title:"提示",message:"委托提交中\n\n是否成功请在委托页面查看。",alignment:"center",success_button:"查看委托单",success:function(){xqBridge.redirect("PAMID"==a.broker.tid&&Util.appVersion()>=7.7?{url:"/broker/trade-history?tid="+a.broker.tid,type:"PUSH"}:{url:"/broker/orders?tid="+a.broker.tid,type:"PUSH"})}})}xqBridge.showLoading();var n={aid:a.broker.aid,tid:a.broker.tid,action:t.action,scode:t.scode,sname:t.sname,price:t.price,amount:t.amount,etype:t.etype,otype:a.type,write_access_token:o};"MKT"===a.type&&(n.oprop=a.oprop),s.oid&&(n.oid=s.oid),"newStock"===a.tradeType&&s.subscribeCode&&(n.scode=s.subscribeCode),r.addClass("disabled"),xqBridge.request({url:"/tc/snowx/order/place.json",type:"POST",data:n,timeout:1e4,success:function(r){if(6e4==r.result_code){var n=function(e){{var o={sname:t.sname,symbol:a.symbol,action:t.action,price:t.price,oid:r.result_data[0].oid,tid:a.broker.tid,otype:a.type};parseFloat($(".commission-amount").text())}"success"===e&&(o.coupon=t.coupon.faceValue,o.couponType=t.coupon.name),"newStock"===a.tradeType&&(o.newStock=!0),window.location.href="./order-success.html?"+$.param(o)};if(e&&clearInterval(e),$(".coupon").is(":visible")&&!_.isEmpty(t.coupon)){var c={reward_owner_id:t.coupon.rewardOwnerId,tid:a.broker.tid,aid:a.broker.aid,oid:r.result_data[0].xoid||r.result_data[0].oid};xqBridge.request({url:"/tc/snowx/reward/lock.json",type:"POST",data:c,success:function(){"BUY"===a.action?a.followStock(a.symbol,n,"success"):n("success")},error:function(){"BUY"===t.action?a.followStock(a.symbol,n,"success"):n()}})}else"BUY"===t.action?a.followStock(a.symbol,n):n()}else"70109"===r.result_code?xqBridge.confirm({title:"提示",message:"您的可用资金不足，请先进行银证转账后再试。",alignment:"left",success_button:"去转账",success:function(){xqBridge.redirect({url:"/broker/transfer",type:"PUSH"})}}):"70105"===r.result_code?xqBridge.confirm({title:"提示",message:"今日开户成功，下个交易日才可正常交易，请耐心等待。如您不是今日开户用户，请点击指定交易，手动开通权限。",alignment:"left",success_button:"指定交易",cancel_button:"知道了",success:function(){var e={aid:a.broker.aid,tid:a.broker.tid,action:"BUY",scode:"799999",sname:"799999",price:1,amount:1,otype:"LMT",write_access_token:o};s.oid&&(e.oid=s.oid),xqBridge.request({url:"/tc/snowx/order/place.json",type:"POST",data:e,timeout:1e4,success:function(e){if(6e4==e.result_code){var r={sname:t.sname,symbol:a.symbol,action:t.action,price:t.price,oid:e.result_data[0].oid,tid:a.broker.tid,otype:a.type};window.location.href="./order-success.html?"+$.param(r)}}})}}):"70114"===r.result_code&&"PAMID"===a.broker.tid?xqBridge.request({url:"/tc/snowx/paopen/query.json",data:{tid:a.broker.tid,aid:a.broker.aid},type:"GET",success:function(e){e&&6e4==e.result_code&&(1==e.result_data.apply_page?xqBridge.confirm({message:"您还没有转签创业板，是否开始转签",success_button:"继续",cancel_button:"返回",success:function(){xqBridge.redirect({url:"/broker/gem-sign",type:"PUSH"})},cancel:function(){}}):-1==e.result_data.status?xqBridge.confirm({message:e.result_data.statusMsg,success_button:"联系小助手",success:function(){xqBridge.redirect({url:"http://xueqiu.com/6123409880/54247396",type:"PUSH"})},cancel:function(){}}):0==e.result_data.status?xqBridge.alert({message:e.result_data.statusMsg,success:function(){}}):Util.toast.show(e.result_data.statusMsg))},complete:function(){xqBridge.hideLoading()}}):-1!==["70010","70000","79014","70007"].indexOf(r.result_code)?i():Util.toast.show(r.msg)},error:function(e){"70005"===e.result_code?Util.toast.show(e.msg):i()},complete:function(){xqBridge.hideLoading(),$("#submit-order").removeClass("disabled")}})},error:function(){$("#submit-order").removeClass("disabled")}})},cancel:function(){$("#submit-order").removeClass("disabled")}})):Util.toast.show("请先完成券商绑定流程");else{if("newStock"===a.tradeType)return!1;Util.checkAndInit({success:function(e){if(errorHandler(e)){var t=e.result_data;a.broker||($(".broker").remove(),a.brokers=t,a.changeBroker())}},cancel:function(){$("#submit-order").removeClass("disabled")},isIB:"USEX"===a.etype})}},followStock:function(e,t,a){function r(){var r="/v4/stock/portfolio/addstock.json";xqBridge.request({url:r,type:"POST",data:{symbol:e,category:2,isnotice:1},complete:function(){t(a)}})}return"newStock"===this.tradeType?(t(a),!1):void xqBridge.getUserInfo({success:function(o){var i=o.uid;xqBridge.request({url:"/stock/portfolio/hasexist.json",data:{code:e,uid:i},success:function(e){return e&&e.hasExist?void t(a):void r()},error:function(){t(a)}})}})},fixData:function(e){var t=this,a=["current","bp1","bp2","bp3","bp4","bp5","sp1","sp2","sp3","sp4","sp5","fall_stop","rise_stop"],r=a.concat(["bc1","bc2","bc3","bc4","bc5","sc1","sc2","sc3","sc4","sc5"]);return _.each(r,function(r){var o=e[r];if(_.isUndefined(o))e[r]="-";else if(_.indexOf(a,r)>-1){var i=t.symbol&&(Util.isFund(t.symbol)||"purchase"===t.tradeType)?3:2;e[r]=parseFloat(o).toFixed(i)}}),e.percentStr=_.isUndefined(e.percentage)?"-":parseFloat(e.percentage).toFixed(2),e},getPanKouInfo:function(e,t){function o(){(e!==i||t)&&("799999"===e?($("#scode").val("登记指定 "+e).data("symbol",e).data("name",e),$(".price").val("1"),$(".amount").attr("placeholder","股票数量").val("1")):($("#scode").val(e).data("symbol",e).data("name",""),$(".price").val(""),"newStock"!==n.tradeType?$(".amount").attr("placeholder","股票数量").val(""):$(".amount").attr("placeholder","申购数量").val("")),$(".price-info").html(a({data:{},isPurchase:"purchase"===n.tradeType})),$(".wudang-prices").html(r({data:n.fixData({}),isPurchase:"purchase"===n.tradeType})).addClass("no-data")),"newStock"===n.tradeType&&n.getStockAmount()}var i=this.symbol;this.symbol=e,this.isFund=Util.isFund(e);var n=this;xqBridge.request({url:"/tc/snowx/pankou.json",data:{symbol:e},success:function(c){if(c&&c.code){c=n.fixData(c),n.data=c,$(".wudang-prices").html(r({data:c,isPurchase:"purchase"===n.tradeType})).removeClass("no-data"),$(".price-info").html(a({data:c,isPurchase:"purchase"===n.tradeType})),"purchase"!==n.tradeType&&$("#scode").val(c.name+" "+c.code).data("symbol",c.code).data("name",c.name);var d=$.trim($(".price").val());(0===d.length&&!$(".price").is(":focus")||e!==i)&&($(".price").val("SELL"===n.action?0==c.bp1||"-"===c.sp1?c.current+"":c.bp1+"":0==c.sp1||"-"===c.sp1?c.current+"":c.sp1+""),n.getStockAmount(),s.price&&("市价"==s.price?($(".trade-type-text").text("市价委托"),$(".trade-type li").removeClass("selected").eq(1).addClass("selected"),n.type="MKT",$(".trade-container").removeClass("LMT MKT").addClass(n.type)):$(".price").val(s.price))),"LMT"==n.type&&$(".wudang-price").each(function(){var e=$(this).text();e==$(".price").val()&&$(this).parents(".prices").addClass("onpress")}),(e!==i||t)&&(n.hasCoupon="init",n.calculateCommission())}else o()},error:function(){o()}})},getStockAmount:function(){var e,t=this,a=t.action;if(e="BUY"===a?"最大可买":"purchase"===t.tradeType?"最大可借出":"最大可卖","newStock"===t.tradeType&&(e="最大可申购"),-1!==_.indexOf(_.without(i,"DYZQ"),t.broker.tid)?(e="输入数量",$(".amount").attr("placeholder",e)):$(".amount").attr("placeholder",e+"--"),!this.broker&&"newStock"!==t.tradeType)return!1;var r=this.broker.aid,o=this.broker.tid,n=$("#scode").data("symbol"),c=$(".price").val()||s.price;if("IB"!==o||c||(c="0"),r&&a&&n&&c){if("PAMID"!==t.broker.tid&&"purchase"===t.tradeType)return $(".amount").attr("placeholder","借出金额").data("amount",0),!1;"newStock"===t.tradeType?(-1!==s.scode.search("SH")&&$(".plus, .minus",$(".amount-group")).data("unit",1e3).find(".step").text("1000"),-1!==s.scode.search("SZ")&&$(".plus, .minus",$(".amount-group")).data("unit",500).find(".step").text("500"),xqBridge.request({url:"/tc/snowx/newshare/amount.json",type:"GET",data:{aid:r,tid:o,etype:t.etype},success:function(a){var r;r=!s.subscribeQty&&a.result_data[t.etype]?a.result_data[t.etype].amount:s.subscribeQty&&!a.result_data[t.etype]?s.subscribeQty:s.subscribeQty&&a.result_data[t.etype]?s.subscribeQty>a.result_data[t.etype].amount?a.result_data[t.etype].amount:s.subscribeQty:"--",$(".amount").attr("placeholder",e+r).data("amount","--"===r?0:r)},error:function(e){Util.toast.show(e)}})):xqBridge.request({url:"/tc/snowx/order/condition/query.json",data:{aid:r,tid:o,action:a,scode:n,price:c},success:function(a){if(6e4==a.result_code){var r=a.result_data[0];if(r){if($(".price").data("etype",r.etype),(r.enable_amount||0==r.enable_amount)&&"newStock"!==t.tradeType){var o=r.enable_amount,n=1;"purchase"===t.tradeType&&(n=100),e+=o*n,o*=n,-1===_.indexOf(_.without(i,"DYZQ"),t.broker.tid)&&$(".amount").attr("placeholder",e).data("amount",o)}s.amount&&$(".amount").val(s.amount);var c=0==r.price_step||_.isNull(r.price_step)?10:r.price_step,d=.001*c;t.broker&&t.broker.tid&&_.indexOf(i,t.broker.tid)>-1&&(d=_.isNull(r.price_step)||_.isUndefined(r.price_step)?"0.01":r.price_step);var u=$(".price-group"),l=u.find(".plus"),p=u.find(".minus");if(_.each([l,p],function(e){e.data("step",d).find(".step").text(d)}),u.find(".step").show(),.001>d&&u.find(".step").css({fontSize:"8px"}).show(),"purchase"!==t.tradeType){var m=0==r.buy_unit||_.isNull(r.buy_unit)?100:r.buy_unit;$(".plus, .minus",$(".amount-group")).data("unit",m).find(".step").text(m)}if(r.entrust_prop&&r.entrust_prop.length){var f=_.first(r.entrust_prop);t.oprop=f.oprop,$(".mkt-price").text(f.desp)}}}else-1===_.indexOf(_.without(i,"DYZQ"),t.broker.tid)&&(e+="--"),$(".amount").attr("placeholder",e).data("amount",0)},error:function(){-1===_.indexOf(_.without(i,"DYZQ"),t.broker.tid)&&(e+="--"),$(".amount").attr("placeholder",e).data("amount",0),$(".price").data("etype","")}})}else-1===_.indexOf(_.without(i,"DYZQ"),t.broker.tid)&&(e+="--"),$(".amount").attr("placeholder",e).data("amount",0),$(".price").data("etype","")},changeBroker:function(e){var a=this.getBrokers(this.brokers,e,this.etype);this.broker=_.find(a,function(e){return e.is_default});var r=t({data:{brokers:a}});$(".broker-list").html(r),"USHK"===this.tradeType&&$(".open").text("免佣开户"),this.tid=e},calculateCommission:function(){var e=this;if("newStock"===e.tradeType||"IB"===e.broker.tid)return!1;var t=$(".price").val(),a=$(".amount").val(),r=$("#stampTax"),o=$("#transferFee"),i=$("#totalCommission"),s=$("#commission"),n=$("#totalAmount");if(t&&a&&e.action&&e.symbol){var c=Util.getCommission(t,a,e.action,e.symbol,e.broker?e.broker.tid:""),d=c.totalAmount,u="DYZQ"===e.broker.tid?6.95:c.calculateAmount,l=c.stampTax,p=c.transferFee,m=c.commission,f=c.repurchase,h=c.repurchaseRate;return n.text(d&&t&&a?"purchase"===e.tradeType?a:t+" x "+a+" = "+d:0),r.html("<div>"+parseFloat(l).toFixed(2)+"</div><div class='amount-tiny'>卖出股票收取0.1%，买入不收</div>"),o.html("<div>"+parseFloat(p).toFixed(2)+"</div><div class='amount-tiny'>买卖沪市股票收取，十万分之二</div>"),s.html(0!==f?"<div>"+parseFloat(m).toFixed(2)+"</div><div class='amount-tiny'>按"+100*h+"%估算</div>":"<div>"+parseFloat(m).toFixed(2)+"</div><div class='amount-tiny'>按万2.5估算，每笔最低5元</div>"),$(".commission-amount").text(u),i.text(u),e.checkCoupon(),"purchase"===e.tradeType&&e.calculatePurchase(u),u}},calculatePurchase:function(e){var t=this;e=e||0;var a=0,r=$(".price").val(),o=$(".amount").val(),i=t.quote.name,s=0,n=parseInt(i.substring(i.length-3,i.length));"SH"===t.quote.exchange&&(s=360),"SZ"===t.quote.exchange&&(s=365),a=parseFloat(o*r/100*n/s-e).toFixed(2),$(".purchase span").text(a+"元")},bindEvent:function(){var t=this,a=$("body");if($(".dialog").css({marginTop:"-"+$(".dialog").height()/2+"px"}),"newStock"!==t.tradeType&&!e){var o=3e3;e=setInterval(function(){!t.symbol||$(".price").is(":focus")||$(".amount").is(":focus")||t.isSelecting||!t.isVisible||t.getPanKouInfo(t.symbol,!1,!0)},o)}a.on("click",".pingan-open",function(){xqBridge.redirect({url:"http://xueqiu.com/broker/open/pingan",type:"PUSH"})}),a.on("click",".pingan-bind",function(){xqBridge.redirect({url:"/broker/bind-list",type:"PUSH"})}),window.viewDidAppear=function(){t.isVisible=!0},window.viewDidDisappear=function(){t.isVisible=!1},a.on("input",".amount,.price",function(){var e=$(this),t=e.val();e.val(t.replace("-",""))}),a.on("click",".overlay",function(){$(this).hide(),$(".trade-type").hide(),$(".type-group").removeClass("active"),$(".select-list").hide(),$(".broker-list").removeClass("expand")}),$(".insurance").on("click",function(){xqBridge.redirect({url:"http://xueqiu.com/broker/insurance/pingan",type:"MODAL"})}),a.on("click",".type-group",function(){if($(this).hasClass("disable"))return!1;if(t.isEdit)return Util.toast.show("改单状态禁止切换委托类型"),!1;var e=$(".trade-type"),a=$(".overlay");e.is(":visible")?$(this).removeClass("active"):$(this).addClass("active"),a.toggle(),e.toggle()}),"newStock"!==this.tradeType?a.on("click",".broker-list .broker",function(){if(t.isEdit)return Util.toast.show("改单状态禁止切换券商"),!1;var e=$(this).parent(),a=$(this),o=$(".broker-list"),s=$(".overlay");if(xqBridge.SNBTrackEvent({page:1504,event:7,info:{from_type:o.find(".selected .broker").data("tid"),to_type:a.data("tid")}}),-1!==a.text().search("待添加"))return!1;if(e.hasClass("select-list")){if(e.hasClass("selected"))return!1;e.addClass("selected"),e.siblings().removeClass("selected");var n=a.data("aid");xqBridge.showLoading(),xqBridge.request({url:"/tc/snowx/securities/default.json",type:"POST",data:{changetoaid:n},success:function(e){if(6e4==e.result_code){Util.appVersion()>=6.5&&xqBridge.updateBrokerList();var n=a.data("tid"),c=t.tradeType;t.changeBroker(n,!0),t.tradeType=-1!==_.indexOf(i,n)?"USHK":"normal",c!==t.tradeType&&(t.symbol=null),t.action="BUY",t.renderTradeBody().then(function(){("normal"===t.tradeType||"purchase"===t.tradeType)&&($("#scode").data("symbol")?t.getPanKouInfo($("#scode").data("symbol"),!0):$(".wudang-prices").html(r({data:t.fixData({}),isPurchase:"purchase"===t.tradeType})).addClass("no-data")),t.updateBodyClass(),t.caculateStyle(),$(".select-list").hide(),s.hide(),o.removeClass("expand"),t.getStockAmount(),t.calculateCommission()})}},error:function(){Util.toast.show("切换账号出错")},complete:function(){xqBridge.hideLoading()}})}else{var c=$(this).find(".arrow");if(!c.length)return!1;var d=$(".select-list");d.is(":hidden")?(d.show(),s.show(),o.addClass("expand")):(d.hide(),s.hide(),o.removeClass("expand")),t.calculateCommission()}}):$(".broker-list .arrow").hide(),a.on("click",".trade-type li",function(){var e=$(this),a=$(".overlay");if(xqBridge.SNBTrackEvent({page:1504,event:8,info:{from_type:$(".trade-type selected").data("type"),to_type:e.data("type"),tid:t.tid||""}}),e.hasClass("selected"))return e.parent().hide(),$(".type-group").removeClass("active"),a.hide(),!1;e.addClass("selected"),e.siblings().removeClass("selected");var r=e.find("span").text();return $(".trade-type-text").text(r),t.type=e.data("type"),$(".trade-container").removeClass("LMT MKT").addClass(t.type),setTimeout(function(){e.parent().hide(),$(".type-group").removeClass("active"),a.hide()},200),!1}),a.on("click",".coupon",function(){var e="";"purchase"===t.tradeType&&(e="purchase"),xqBridge.redirect({url:"/broker/coupon-pick?coupon="+t.coupon.rewardOwnerId+"&type="+e+"&tid="+t.broker.tid,type:"MODAL",success:function(e){e&&t.couponList.map(function(a){"none"===e&&($(".coupon").css({display:"block"}),$("#coupon-text").text("未使用").css({color:"#ccc"}),t.coupon={},$(".coupon i").hide(),t.hasCoupon="keep"),a.rewardOwnerId===e&&(t.coupon=a,$(".coupon").css({display:"block"}),$("#coupon-text").css({color:"#FF7700"}).text("DYZQ"===t.broker.tid?a.name+"($"+a.faceValue+")":a.name+"(￥"+a.faceValue+")"),t.hasCoupon="keep")})}})}),a.on("click",".no-broker .open",function(e){e.preventDefault();var a="http://xueqiu.com/broker/open/pingan?from=xiadan";"USEX"===t.etype&&(a="http://xueqiu.com/broker/open/DYZQ?from=xiadan"),xqBridge.redirect({type:"PUSH",url:a})}),a.on("click",".no-broker .add",function(e){e.preventDefault();var a="/broker/bind-list";"USEX"===t.etype&&(a+="?ib=true"),xqBridge.redirect({type:"MODAL",url:a,success:function(e){e&&!_.isEmpty(e)&&t.init()}})});var n=navigator.userAgent.indexOf("iPhone")>-1;n||$(".no-broker a").css({padding:"5px"}),"newStock"!==t.tradeType&&(a.on("click",".control p",function(){$(this).find("input").focus()}),a.on("focus","#scode",function(e){e.preventDefault();var a=this;if($(a).blur(),!$(a).hasClass("search-opened")){xqBridge.trackEvent("trade_selectStock"),$(a).addClass("search-opened");var r=t.broker?t.broker.etype:"";xqBridge.searchTCStock({etype:r,success:function(e){t.symbol=e,t.etype=Util.getEtypeBySymbol(e),t.isUSHK=-1!==r.search("USEX")||-1!==r.search("HKEX"),t.renderTradeBody().then(function(){t.updateBodyClass(),t.caculateStyle()}),$(a).removeClass("search-opened"),t.getPanKouInfo(e,!0)},cancel:function(){$(a).removeClass("search-opened")}})}})),a.on("click",".price-group button",function(){var e=$(".price"),a=parseFloat(e.val());if(_.isNaN(a))return!1;var r=parseFloat($(this).data("step")),o=(r+"").replace("0.","").length;if($(this).hasClass("minus")?(a-=r,xqBridge.trackEvent("trade_priceDown"),xqBridge.SNBTrackEvent({page:1504,event:3,info:{type:"priceDown"}})):(xqBridge.trackEvent("trade_priceUp"),xqBridge.SNBTrackEvent({page:1504,event:3,info:{type:"priceUp"}}),a+=r),a>0){var i=a.toFixed(o);e.val(i),t.getStockAmount()}return t.calculateCommission(),!1}),a.on("click",".amount-group button",function(){var e=$(".amount"),a=parseInt(e.val()||"0"),r=$(this);if(_.isNaN(a))return!1;var o=a,i=parseInt(r.data("unit"),10);return r.hasClass("minus")?(xqBridge.trackEvent("trade_numberDown"),xqBridge.SNBTrackEvent({page:1504,event:5,info:{type:"numberDown"}}),o-=i):(xqBridge.trackEvent("trade_numberUp"),xqBridge.SNBTrackEvent({page:1504,event:5,info:{type:"numberUp"}}),o+=i),o>=0&&e.val(o),t.calculateCommission(),!1}),a.on("click",".control",function(){$(this).find("input").focus()}),a.on("click",".trade-action button",function(){if(t.isEdit)return Util.toast.show("改单状态禁止切换买卖类型"),!1;$("#scode").data("symbol");$(".trade-action .select").removeClass("select"),$(this).addClass("select"),t.action=$(this).data("action"),t.getStockAmount(),t.updateBodyClass();var e="BUY"===t.action?"买  入":"卖  出";return $("#submit-order span").html(e),"SELL"===t.action?($("body").addClass("SELL"),$(".all-in").show()):($("body").removeClass("SELL"),$(".all-in").hide()),t.calculateCommission(),!1}),a.on("blur",".price",function(){t.getStockAmount(),t.calculateCommission()}),a.on("click",".prices",function(){xqBridge.SNBTrackEvent({page:1504,event:12,info:{}}),$(this).addClass("onpress"),$(this).siblings().removeClass("onpress"),$(".price").val($(this).find(".wudang-price").text()),t.getStockAmount(),t.calculateCommission()}),a.on("blur","input[type='number']",function(){t.calculateCommission()}),a.on("click",".question-mark",function(){xqBridge.trackEvent("trade_fee"),xqBridge.SNBTrackEvent({page:1504,event:10,info:{}}),Util.overlay.showOverlay($(".dialog"),!0)}),a.on("click","#close-dialog",function(){Util.overlay.hideOverlay($(".dialog"))}),$("input.price").on("blur",function(){xqBridge.SNBTrackEvent({page:1504,event:6,info:{}})}),$("input.amount").on("blur",function(){xqBridge.SNBTrackEvent({page:1504,event:4,info:{}})}),a.on("click",".all-in",function(){return xqBridge.trackEvent("trade_sellAll"),xqBridge.SNBTrackEvent({page:1504,event:13,info:{}}),t.broker?"SUCCESS"===t.broker.status?xqBridge.redirect({url:"/broker/order?tid="+t.broker.tid,type:"PUSH"}):Util.toast.show("请先完成绑定流程！"):Util.toast.show("请先绑定券商！"),!1}),a.on("click",".stock-current",function(){"LMT"===t.type&&t.data&&t.data.current&&($(".price").val(t.data.current),$(".prices").removeClass("onpress"),t.calculateCommission())}),a.on("click",".rise-stop",function(){"LMT"===t.type&&t.data&&t.data.rise_stop&&($(".price").val(t.data.rise_stop),$(".prices").removeClass("onpress"),t.calculateCommission())}),a.on("click",".fall-stop",function(){"LMT"===t.type&&t.data&&t.data.fall_stop&&($(".price").val(t.data.fall_stop),$(".prices").removeClass("onpress"),t.calculateCommission())}),a.on("click",".amount-select div",function(){var e=$(".amount").data("amount"),a=$(this),r=0,o=parseInt($(".amount-group button").data("unit"),10)||100;"purchase"===t.tradeType&&(o="SZ"===t.quote.exchange?1e3:1e5),e&&(a.hasClass("three")&&(xqBridge.trackEvent("trade_third"),xqBridge.SNBTrackEvent({page:1504,event:1,info:{type:3}}),r=Math.floor(e/(3*o))*o),a.hasClass("two")&&(xqBridge.trackEvent("trade_half"),xqBridge.SNBTrackEvent({page:1504,event:1,info:{type:2}}),r=Math.floor(e/(2*o))*o),a.hasClass("all")&&(xqBridge.trackEvent("trade_whole"),xqBridge.SNBTrackEvent({page:1504,event:1,info:{type:1}}),r=Math.floor(e/o)*o),o>r&&"newStock"!==t.tradeType&&(r=o)),r>0&&$(".amount").val(r),t.calculateCommission()}),a.on("click","#submit-order",function(e){e.preventDefault(),xqBridge.trackEvent("trade_buyAndSell");var a=$(this);if(a.hasClass("disabled"))return!1;var r={};if(r.action=t.action,r.title="BUY"==r.action?"确认买入":"确认卖出",r.scode=$("#scode").data("symbol"),r.sname=$("#scode").data("name"),r.price=$(".price").val()||s.price,r.etype=t.etype,r.amount=$(".amount").val(),r.total=r.price*r.amount,r.totalText=r.total.toFixed(2),r.coupon=t.coupon,"purchase"===t.tradeType){if(!r.price)return void Util.toast.show("请输入借出年利率");if(!r.amount)return void Util.toast.show("请输入借出金额")}if(xqBridge.SNBTrackEvent({page:1504,event:11,info:{tid:t.tid||""}}),t.isUSHK){var o=$(".plus",$(".price-group")).data("step");if(o&&"0"!=o){var n=1/o;if(parseInt(r.price*n,10)%1)return Util.toast.show("买卖价格需为报价最小单位整数倍"),!1}if(r.amount%1&&"BUY"===r.action)return Util.toast.show("买入数量需为整数"),!1;var c=$(".plus",$(".amount-group")).data("unit");if(c&&"HKEX"===r.etype&&"BUY"===r.action&&r.amount%c)return Util.toast.show("数量需为每手股数的整数倍"),!1}if(xqBridge.trackEvent("BUY"===r.action?"trade_buy":"trade_sell"),"purchase"===t.tradeType){var d=parseInt(t.quote.name.substring(t.quote.name.length-3,t.quote.name.length))+"天期";r.message="借出周期："+(d?d+" ":"")+"\n借出年利率："+("LMT"===t.type?r.price:"市价")+"%\n借出金额："+r.amount+"元\n预期收益："+$(".purchase span").text().replace("元","")+"（参考）\n",r.amount=r.amount/100}else r.message="股票："+(r.sname?r.sname+" ":"")+r.scode+"\n价格："+("LMT"===t.type?r.price:"市价")+"\n数量："+r.amount+"\n";if("LMT"===t.type&&"purchase"!==t.tradeType&&(r.message+="金额："+r.totalText+"\n"),t.broker&&"newStock"!==t.tradeType&&"799999"!==t.symbol&&-1==_.indexOf(i,t.broker.tid)&&(r.message+="手续费："+t.calculateCommission()+"（参考）\n"),$(".coupon").is(":visible")&&!_.isEmpty(t.coupon)&&(r.message+=t.coupon.name+"：-"+t.coupon.faceValue+"元\n"),"MKT"===t.type){var u=parseFloat(r.price)>=parseFloat($(".rise-stop .stock_up").text()),l=parseFloat(r.price)<=parseFloat($(".fall-stop .stock_down").text());(u||l)&&-1===_.indexOf(i,t.broker.tid)&&xqBridge.confirm({title:"提示",message:"涨跌停时市价委托会出现废单，是否继续？",alignment:"center",success_button:"继续",success:function(){t.checkBind(r)},cancel:function(){return!1}}),r.price&&""!==r.price||($(".price").val(0),r.price="0.00")}return t.validate.validateAll()?void t.checkBind(r):void a.removeClass("disabled")})}}});