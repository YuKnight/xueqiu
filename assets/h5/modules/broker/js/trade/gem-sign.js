define(function(require,exports,module){function e(e){var t={11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江 ",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北 ",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏 ",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外 "},s="",i=!0,r=18==e.length?e.substr(6,8):"19"+e.substr(6,6),n=moment(r,"YYYYMMDD").fromNow().split(" ")[0];if(e)if(/(^\d{15}$)|(^\d{17}(\d|X)$)/i.test(e))if(t[e.substr(0,2)]){if(18>n)s="未满18周岁",i=!1;else if(18==e.length){e=e.split("");for(var a=[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2],u=[1,0,"X",9,8,7,6,5,4,3,2],c=0,d=0,o=0,l=0;17>l;l++)d=e[l],o=a[l],c+=d*o;{u[c%11]}u[c%11]!=e[17]&&(s="请输入有效的身份证号",i=!1)}}else s="请输入有效的身份证号",i=!1;else s="请输入有效的身份证号",i=!1;else s="请输入身份证号",i=!1;var g={pass:i,tip:s};return g}function t(e){return e&&6e4==e.result_code?!0:void(!e||70005!=e.result_code&&70006!=e.result_code?xqBridge.alert(e&&(e.error_description||e.msg)?{message:e.msg||e.error_description,success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}:{message:"网络错误",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}):xqBridge.redirect({type:"POP_CANCEL"}))}var s,i={QUERY:"/tc/snowx/paopen/query.json",SIGN:"/tc/snowx/paopen/sign.json"},r="PAMID",n={"-1":"fail",0:"signing",1:"success"};module.exports={init:function(){var e=this;$.when(e.getAID(r)).then(function(){e.bindEvent(),e.queryStatus()})},getAID:function(e){var t=jQuery.Deferred();return Util.checkBindBroker({success:function(i){i&&6e4==i.result_code&&(s=_.filter(i.result_data,function(t){return t.tid==e})[0].aid),t.resolve(i)},error:function(e){t.reject(e)}}),t.promise()},gemSign:function(e){$(".btn-submit").attr("disabled",!0),xqBridge.showLoading(),xqBridge.request({url:i.SIGN,data:{tid:r,aid:s,card_id:e},type:"POST",success:function(e){if(e)if(72105==e.result_code||72106==e.result_code)Util.toast.show(e.msg),$(".id-code input").val("");else if(6e4==e.result_code){var s=e.result_data.apply_status;switch(s){case-1:xqBridge.confirm({message:e.result_data.statusMsg,success_button:"联系小助手",success:function(){xqBridge.redirect({url:"https://xueqiu.com/6123409880/54247396",type:"PUSH"})},cancel:function(){}});break;case 0:case 1:xqBridge.alert({message:e.result_data.statusMsg,success:function(){xqBridge.redirect({type:"POP"})}})}}else t(e)},complete:function(){xqBridge.hideLoading(),$(".btn-submit").attr("disabled",!1)}})},queryStatus:function(){xqBridge.showLoading(),xqBridge.request({url:i.QUERY,data:{tid:r,aid:s},type:"GET",success:function(e){if(t(e),e&&6e4==e.result_code&&0==e.result_data.apply_page){$(".sign").addClass("none"),$(".status").removeClass("none");var s=e.result_data.status;$(".tip-signing").text(e.msg),$(".status-wrap").attr("class","status-wrap").addClass(n[s]),$(".btn-wrap").attr("class","btn-wrap").addClass(n[s]),-1==s&&($(".res-fail .tip").text(e.result_data.statusMsg),1==e.result_data.failType&&$(".btn-little-helper").text("如何开通"))}else $(".status").addClass("none"),$(".sign").removeClass("none")},complete:function(){xqBridge.hideLoading()}})},bindEvent:function(){var t=this,s=$(".btn-submit"),i=$(".agreement input"),r=$(".id-code input");r.on("keyup blur",function(t){var n=$.trim(r.val()),a=e(n);a.pass&&i.is(":checked")?s.attr("disabled",!1):("blur"!=t.type||a.pass||Util.toast.show(a.tip),s.attr("disabled",!0))}),i.on("change",function(){var t=$.trim(r.val()),n=e(t);n.pass&&i.is(":checked")?s.attr("disabled",!1):s.attr("disabled",!0)}),s.on("click",function(i){if(s.attr("disabled"))return!1;var n=$.trim(r.val()),a=e(n);return a.pass&&t.gemSign(n),i.preventDefault(),!1}),$(".helper").on("click",function(){xqBridge.redirect({url:"https://xueqiu.com/broker/trade/qa/gemSign",type:"PUSH"})}),$(".btn-sign-again").on("click",function(){$(".status").addClass("none"),$(".sign").removeClass("none")}),$(".law").on("click",function(){xqBridge.redirect({url:"https://xueqiu.com/law/gemsign",type:"PUSH"})})}}});