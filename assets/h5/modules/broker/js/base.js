$(function(){FastClick.attach(document.body)}),function(e){function t(e){var t=e.data;t&&t.aid&&(t.write_access_token?xqBridge.getWriteToken({aid:t.aid,success:function(t){e.data.write_access_token=t,r(e)}}):r(e))}function n(n){function s(o){if(!o||70005!=o.result_code&&70006!=o.result_code&&70015!=o.result_code)o&&70008==o.result_code?xqBridge.verifyTelephone({type:"bind",success:function(){"request"===n.name&&r(n)},cancel:function(){n.error&&e[n.error]&&e[n.error](o)}}):i&&(_.isFunction(i)?i(o):e[i]&&e[i](o));else if(Util.appVersion()>=6.5&&o.result_data&&o.result_data.page_type&&2==o.result_data.page_type)o.result_data.tid=o.result_data.tid||o.result_data.oauth_params.tid,e.hasRedirect||(e.hasRedirect=!0,xqBridge.refreshBrokerToken({data:o,success:function(){"request"===n.name&&(e.hasRedirect=!1,t(n))},cancel:function(){e.hasRedirect=!1,n.error&&e[n.error]&&e[n.error](o)}}));else{var s=o.refresh_url||o.rebind_url;s&&(e.hasRedirect||(e.hasRedirect=!0,s=-1===s.search("xueqiu.com")?"/broker/proxy?url="+encodeURIComponent(s):encodeURI(s),xqBridge.showLoading(),xqBridge.redirect({url:s,type:"MODAL",success:function(){"request"===n.name&&(e.hasRedirect=!1,t(n))},cancel:function(){e.hasRedirect=!1,n.error&&e[n.error]&&e[n.error](o)}})))}}var i=n.success;"request"===n.name&&(_.isFunction(i)||_.isUndefined(i))&&(n.success=n.success?function(e){s(e)}:function(e){s(e)});var c=["success","cancel","error","complete","action"];_.each(c,function(t){if(n[t]&&_.isFunction(n[t])){var r="cb"+ ++o,s=n[t];n[t]=r,e[r]=function(e){"string"==typeof e&&(e=decodeURIComponent(e),(/^\{.*\}$/.test(e)||/^\[.*\]$/.test(e))&&(e=$.parseJSON(e))),s(e),"action"!==t&&console.log("delete "+r)}}})}function r(t){if(_.isObject(t))if("setToolbar"===t.name&&t.buttons&&t.buttons.length){if(e.isSetToolbar)return!1;e.isSetToolbar=!0,_.each(t.buttons,function(e){n(e)})}else if("setRightNavigationButton"===t.name){if(e.isSetRightNavigationButton)return!1;e.isSetRightNavigationButton=!0,n(t)}else n(t);var r=document.createElement("iframe"),o=_.isObject(t)?JSON.stringify(t):t;console.log(o),r.setAttribute("src","js://"+encodeURIComponent(o)),document.documentElement.appendChild(r),r.parentNode.removeChild(r),r=null}var o=0;e.eventObj={},e.xqBridge={showLoading:function(){r("showloading")},hideLoading:function(){r("hideloading")},alert:function(e){e&&_.isObject(e)&&(e.name="alert"),r(e)},datePicker:function(e){e&&_.isObject(e)&&(e.name="datePicker"),r(e)},error:function(e){e&&_.isObject(e)&&(e.name="error"),r(e)},confirm:function(e){e&&_.isObject(e)&&(e.name="confirm"),r(e)},verifyTelephone:function(e){e&&_.isObject(e)&&(e.name="verifyTelephone"),r(e)},pay:function(e){e&&_.isObject(e)&&(e.name="pay"),r(e)},request:function(e){e&&_.isObject(e)&&(e.name="request",_.isUndefined(e.type)&&(e.type="GET"),e.data&&e.data.tid&&Util.appVersion()>=7.7&&(e.url=-1!==e.url.search("/tc/snowx/")?e.url.replace("/snowx/","/snowx/"+e.data.tid.toUpperCase()+"/"):e.url.replace("/tc/","/tc/"+e.data.tid.toUpperCase()+"/"))),r(e)},mergeRequests:function(e){e&&_.isObject(e)&&(e.name="mergeRequests"),r(e)},redirect:function(e){e&&_.isObject(e)&&(e.name="redirect"),e.url&&e.url.indexOf("broker/proxy")>-1&&(e.url+="&hasEncode=1"),r(e)},updateBrokerInfo:function(e){e&&_.isObject(e)&&(e.name="updateBroker"),r(e)},setToolbar:function(e){e&&_.isObject(e)&&(e.name="setToolbar"),r(e)},getAccessToken:function(e){e&&_.isObject(e)&&(e.name="getAccessToken"),r(e)},getWriteToken:function(e){e&&_.isObject(e)&&(e.name="getWriteToken"),r(e)},getUserInfo:function(e){e&&_.isObject(e)&&(e.name="getUserInfo"),r(e)},getAID:function(e){e&&_.isObject(e)&&(e.name="getAID"),r(e)},searchTCStock:function(e){e&&_.isObject(e)&&(e.name="searchTCStock"),r(e)},setToolbar:function(e){e&&_.isObject(e)&&(e.name="setToolbar"),r(e)},setRightNavigationButton:function(e){e&&_.isObject(e)&&(e.name="setRightNavigationButton"),r(e)},on:function(e,t){var n=eventObj[e];n?n.push(t):(n=[t],eventObj[e]=n)},off:function(e,t){if(t){var n=eventObj[e];n&&n.length&&(n=_.reject(n,function(e){return e==t}))}else delete eventObj[e]},trigger:function(e){var t=eventObj[e];t&&t.length&&_.each(t,function(e){e()})},share:function(e){e&&_.isObject(e)&&(e.name="share"),r(e)},trackEvent:function(e){"string"==typeof e&&(e={event:e}),e&&_.isObject(e)&&(e.name="trackEvent"),r(e)},SNBTrackEvent:function(e){return Util.appVersion()<7.6?!1:navigator.userAgent.indexOf("Android")>0&&Util.appVersion()<7.8?!1:(e&&_.isObject(e)&&(e.name="SNBTrackEvent"),void r(e))},wakeApp:function(e){e&&_.isObject(e)&&(e.name="wakeApp"),r(e)},newRetweet:function(e){e&&_.isObject(e)&&(e.name="newRetweet"),r(e)},replyComment:function(e){e&&_.isObject(e)&&(e.name="replyComment"),r(e)},bindBroker:function(e){e&&_.isObject(e)&&(e.name="bindBroker"),r(e)},refreshBrokerToken:function(e){e&&_.isObject(e)&&(e.name="refreshBrokerToken"),r(e)},goToTradeHome:function(){r("goToTradeHome")},updateBrokerList:function(){r("updateBrokerList")},encryptWithRSA:function(e){e&&_.isObject(e)&&(e.name="encryptWithRSA",e.origin=e.origin+""),r(e)}},e.Util={bindBroker:function(e){var t="/broker/bind-list";e.isIB&&(t+="?market=USHK"),xqBridge.redirect({url:t,type:"MODAL",success:e.success,cancel:e.cancel})},verifyPassword:function(e){xqBridge.redirect({url:e.url,type:"MODAL",success:e.success,cancel:e.cancel})},checkBindBroker:function(t){t.success&&t.error&&xqBridge.request({url:"/tc/snowx/securities/bound.json",success:function(n){var r=n.result_data;r&&r.length?(e.userInfo.brokerList=r,t.success(n)):t.success(!1)},error:function(e){t.error(e)}})},checkAndInit:function(e){var t=this;e.success&&e.cancel&&t.checkBindBroker({isIB:e.isIB,success:function(n){if(n)e.success(n);else{var r="/broker/bind-list";e.isIB&&(r+="?ib=true"),xqBridge.redirect({type:"PUSH",url:r,success:function(){t.checkAndInit(e)},cancel:function(t){e.cancel(t)}})}},error:function(t){e.cancel(t)}})},newGetAndRefreshToken:function(e){function t(){xqBridge.getWriteToken({aid:e.aid,success:function(t){e.success&&e.success(t)}})}function n(){if("trade"===e.from&&xqBridge.trackEvent("trade_passwordAlert"),e.broker&&2==e.broker.page_type)xqBridge.refreshBrokerToken({data:{result_data:e.broker},success:function(){t()},cancel:function(t){e.error&&e.error(t)}});else{var n="";n=-1===e.renew_url.search("xueqiu.com")?"/broker/proxy?url="+encodeURIComponent(e.renew_url):encodeURI(e.renew_url),xqBridge.redirect({url:n,type:"MODAL",success:function(){t()},cancel:function(t){e.error&&e.error(t)}})}}xqBridge.request({url:"/tc/snowx/accesstoken/expires/query.json",success:function(t){if(6e4==t.result_code){var r=t.result_data;r&&0==r.accessTokenExpires?n():xqBridge.getWriteToken({aid:e.aid,success:function(t){t&&"string"==typeof t?e.success&&e.success(t):n()}})}else n()},error:function(){n()}})},getAndRefreshToken:function(e){var t=this;t.appVersion()>=6.5?t.newGetAndRefreshToken(e):xqBridge.getWriteToken({aid:e.aid,success:function(t){function n(){xqBridge.getWriteToken({aid:e.aid,success:function(t){e.success&&e.success(t)}})}t?e.success&&e.success(t):xqBridge.redirect({url:"/broker/proxy?url="+encodeURIComponent(e.renew_url),type:"MODAL",success:function(){n()},cancel:function(t){e.cancel&&e.cancel(t)}})}})},parseParams:function(t){var n=t||e.location.href,r=n.split("?"),o="";if(1===r.length)return{};o=_.last(r);var s=/([^&=]+)=?([^&]*)/g,i=/\+/g,c=function(e){return decodeURIComponent(e.replace(i," "))};o=decodeURIComponent(o);for(var a,u={};a=s.exec(o);){var d=c(a[1]),f=c(a[2]);"[]"===d.substring(d.length-2)?(d=d.substring(0,d.length-2),(u[d]||(u[d]=[])).push(f)):u[d]=f}return u},showError:function(t,n){var r=$(".error-tip"),o=t.length,s=14*o,i=s+20,c=$(e).scrollTop(),a=$(e).height();r.length||($("body").append('<div class="error-tip"></div>'),r=$(".error-tip")),r.css({width:i+"px","margin-left":"-"+i/2+"px",top:c+a/2+"px"}),r.text(t).show(),setTimeout(function(){r.hide(),n&&n()},1500)},setPress:function(e,t){var n=$("body"),r="touchstart",o="touchend",s="touchmove";!1 in document.documentElement&&(r="mousedown",o="mouseup",s="mousemove");var i=!1;n.on(r,e,function(){var e=$(this);setTimeout(function(){console.log("start",i),i||e.hasClass(t)||(e.addClass(t),e.data("nopress",!1))},100)}),n.on(s,e,function(){var e=$(this);i=!0,console.log("move",i),e.removeClass(t)}),n.on(o,e,function(){var e=$(this);setTimeout(function(){i=!1,console.log("end",i),e.removeClass(t)},200)}),-1==navigator.userAgent.indexOf("iPhone")&&n.on(o,function(){i=!1})},appVersion:function(){var e=5,t=navigator.userAgent.split(" ");if(t.length>=3){var n=t[2],r=n.split("-");e=parseFloat(r[0])}return e},getBroker:function(e,t){var n;return t?(n=_.find(e,function(e){return e.tid==t}),n&&(n.is_default=!0)):n=_.find(e,function(e){return e.is_default}),e.length&&!n&&(n=_.first(e),n.is_default=!0),n},getCommission:function(e,t,n,r,o){if(r){var s=parseFloat(e*t).toFixed(2),i=0,c=0,a=0,u=0,d=this.getStockInfo(r),f=this.getRepurchase(r),l=f.repurchase,m=f.repurchaseRate,p=0!==l;return p&&(s=t||0),s=parseFloat(s).toFixed(2),c="A股"!==d.name&&"深B"!==d.name&&"沪B"!==d.name||"SELL"!==n?"0.00":.001*s,c=parseFloat(c).toFixed(2),a=-1===r.search("SH")||"A股"!==d.name&&"沪B"!==d.name||"股票"!==d.type||0===parseInt(s)?"0.00":2e-5*s,a=parseFloat(a).toFixed(2),this.specialStockCommission(r,o)&&(u=25e-5*s,p?u=s*m:u>0&&5>u&&e&&t&&(u=5)),u=parseFloat(u).toFixed(2),i=parseFloat(c)+parseFloat(a)+parseFloat(u),{calculateAmount:parseFloat(i).toFixed(2),totalAmount:s,commission:u,transferFee:a,stampTax:c,repurchase:l,repurchaseRate:m}}},overlay:{$overlay:$("#overlay"),showOverlay:function(e,t){var n=this;return $("#container").css({overflow:"hidden"}),e&&e.show(),n.$overlay.length?n.$overlay.show():($("body").append("<div id='overlay'></div>"),n.$overlay=$("#overlay"),n.$overlay.css({height:"100%",opacity:.2,position:"fixed",top:0,left:0,"background-color":"black",width:"100%","z-index":4400,display:"none"}).show(),t&&n.$overlay.on("touchstart",function(){$("#container").css({overflow:"scroll"}),$(this).hide(),e&&e.hide()})),n.$overlay},hideOverlay:function(e){$("body").css({overflow:"scroll"}),$("#overlay").hide(),e&&e.hide()}},toast:{toastStyle:{position:"fixed",padding:"10px",boxSizing:"border-box",background:"rgba(0, 0, 0, 0.7)",color:"#fff",fontSize:"16px",textAlign:"center",borderRadius:"4px",maxWidth:"80%","line-height":1.4,"z-index":99999,"animation-duration":"200ms","animation-fill-mode":"forwards"},toastTimeout:null,show:function(e){var t=this,n=$(".toast");t.toastTimeout&&clearTimeout(t.toastTimeout),n.length>0?(n.fadeOut(200),setTimeout(function(){n.html(e).fadeIn(200),t.fixPos(),t.toastTimeout=setTimeout(function(){n.fadeOut(200)},1300)},200)):(n=$("<div class='toast'>"+e+"</div>"),$("body").append(n),n.css(t.toastStyle),n.fadeIn(200),t.fixPos(),t.toastTimeout=setTimeout(function(){n.fadeOut(200)},1300))},fixPos:function(){var e=$(".toast");if(e){var t=e.outerHeight(),n=e.outerWidth(),r=document.body.getBoundingClientRect().height,o=document.body.getBoundingClientRect().width;e.css("top",.4*r-t/2+"px"),e.css("left",o/2-n/2+"px")}}},errorHandler:function(e){return xqBridge.hideLoading(),e&&6e4==e.result_code?!0:void(!e||70005!=e.result_code&&70006!=e.result_code?xqBridge.alert(e&&(e.error_description||e.msg)?{message:e.msg||e.error_description,success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}:{message:"网络错误",success:function(){xqBridge.redirect({type:"POP_CANCEL"})}}):xqBridge.redirect({type:"POP_CANCEL"}))},specialStockCommission:function(e,t){var n=!0,r=["SH511880","SH511980","SH511990","SH511810","SH511890","SH511860","SZ159003","SZ159005","SZ159001","SH511800","SH511830"],o=["SH511880","SH511980","SH511990","SH511810","SH511890","SH511860","SZ159003","SZ159005","SZ159001"];return("GJZQ"===t||t===Util.appVersion()>=7.2?"PAMID":"PINGAN")&&_.contains(r,e)&&(n=!1),"GLZQ"===t&&_.contains(o,e)&&(n=!1),n},getRepurchase:function(e){var t,n;switch(e){case"SH204001":case"SZ131810":t=1,n=1e-5;break;case"SH204002":case"SZ131811":t=2,n=2e-5;break;case"SH204003":case"SZ131800":t=3,n=3e-5;break;case"SH204004":case"SZ131809":t=4,n=4e-5;break;case"SH204007":case"SZ131801":t=7,n=5e-5;break;case"SH204014":case"SZ131802":t=14,n=1e-4;break;case"SH204028":case"SZ131803":t=28,n=2e-4;break;case"SH204091":case"SZ131805":t=91,n=3e-4;break;case"SH204182":case"SZ131806":t=182,n=3e-4;break;default:t=0,n=1e-5}return{repurchase:t,repurchaseRate:n}},getStockInfo:function(e){var t,n={HKHSI:1,HKHSF:1,HKHSU:1,HKHSP:1,HKHSC:1,HKVHSI:1,HKHSCEI:1,HKHSCCI:1,HKGEM:1,HKHKL:1},r={DJI30:1,NASDAQ:1,SP500:1,ICS30:1,SLR10:1,TMT20:1,HCP10:1,EDU10:1},o={BTCNCNY:{money:"￥",market:"比特币（CNY）"},MTGOXAUD:{money:"AU$",market:"比特币（AUD）"},MTGOXCNY:{money:"￥",market:"比特币（CNY）"},MTGOXEUR:{money:"€",market:"比特币（EUR）"},MTGOXGBP:{money:"£",market:"比特币（GBP）"},MTGOXJPY:{money:"J￥",market:"比特币（JPY）"},MTGOXUSD:{money:"$",market:"比特币（USD）"},LOCALBTCAUD:{money:"AU$",market:"比特币（AUD）"},BTCDEEUR:{money:"€",market:"比特币（EUR）"},BTCEEUR:{money:"€",market:"比特币（EUR）"},LOCALBTCGBP:{money:"£",market:"比特币（GBP）"},BTCEUSD:{money:"$",market:"比特币（USD）"},BITSTAMPUSD:{money:"$",market:"比特币（USD）"}},s=["SH500","SH510","SH511","SH512","SH513","SH518","SH519","SZ15","SZ18","SZ16"];if(e&&(~_.indexOf(s,e.substr(0,5))||~_.indexOf(s,e.substr(0,4))))t={type:"基金",name:"基金",exchange:"沪深",money:"￥"};else if(/^MF\d+$/.test(e))t={type:"货币基金",name:"货币基金",exchange:"沪深",money:"￥"};else if(/^P\d+$/.test(e))t={type:"私募基金",name:"私募基金",exchange:"沪深",money:"￥"},"P000057"===e&&(t.money="$");else if(/^FP\d+$/.test(e))t={type:"理财产品",name:"理财产品",exchange:"沪深",money:"￥"};else if(/^[\d\w]+\.FM$/.test(e))t={type:"国债期货",name:"国债期货",exchange:"沪深",money:"￥"};else if(/^TP\d+$/.test(e))t={type:"信托产品",name:"信托产品",exchange:"沪深",money:"￥"};else if(/^ZH\d{6}$/.test(e))t={type:"投资组合",name:"投资组合",exchange:"组合",money:"￥"};else if(/^S[HZ]\d+$/.test(e)||/^CSI/.test(e)&&9===e.length)t=/^SZ200/.test(e)?{type:"股票",name:"深B",exchange:"沪深",money:"HK$"}:/^(SH(201|202|203|204|131)|SZ(13|395032))/.test(e)?{type:"回购",name:"回购",exchange:"沪深",money:"￥"}:/^(SH(01|02|13)|SZ(10|09))/.test(e)?{type:"国债",name:"国债",exchange:"沪深",money:"￥"}:/^(SH12|SZ11)/.test(e)?{type:"企债",name:"企债",exchange:"沪深",money:"￥"}:/^(SH11|SZ12)/.test(e)?{type:"可转债",name:"可转债",exchange:"沪深",money:"￥"}:/^SH900/.test(e)?{type:"股票",name:"沪B",exchange:"沪深",money:"$"}:/^(SH00|SZ399|CSI)/.test(e)?{type:"指数",name:"指数",exchange:"沪深",money:""}:{type:"股票",name:"A股",exchange:"沪深",money:"￥"};else if(/^\d+$/.test(e))t={type:"股票",name:"港股",exchange:"港股",money:/^8/.test(e)?"￥":"HK$"};else if(n[e]||r[e])t={type:"指数",name:"指数",exchange:"",money:""};else{var i=o[e];t=i?{type:"比特币",name:"比特币",exchange:i.market,money:i.money}:{type:"股票",name:"美股",exchange:"美股",money:"$"}}return t},getEtypeBySymbol:function(e){if(!e)return"";var t="",n=this.getStockInfo(e),r=n.exchange;return"美股"===r&&(t="USEX"),"港股"===r&&(t="HKEX"),"沪深"===r&&e.indexOf("SH")>-1&&(t="SHEX"),"沪深"===r&&e.indexOf("SZ")>-1&&(t="SZEX"),"799999"===e&&(t="SHEX"),t},isFund:function(e){var t=["SH500","SH502","SH510","SH511","SH513","SZ15","SZ18","SZ16"];return _.indexOf(t,e.substr(0,5))>-1||_.indexOf(t,e.substr(0,4))>-1?!0:!1}},baseInit=function(){e.userInfo={},e.viewDidAppear=function(){},e.viewDidDisappear=function(){}},baseInit()}(window);